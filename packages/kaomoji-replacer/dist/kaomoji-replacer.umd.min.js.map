{"version":3,"file":"kaomoji-replacer.umd.min.js","sources":["../src/core/KaomojiReplacer.js","../src/core/SearchEngine.js","../src/core/KaomojiDataManager.js","../src/storage/IndexedDBStorage.js","../index.js"],"sourcesContent":["/**\n * KaomojiReplacer.js\n * 核心替换引擎 - 可独立使用，不依赖任何框架\n * 负责检测文本中的标记并替换为对应的 kaomoji\n */\n\nclass KaomojiReplacer {\n    constructor(searchEngine) {\n        this.searchEngine = searchEngine;\n\n        // 标记格式配置\n        this.config = {\n            // 标记的正则表达式: [kaomoji:关键词1,关键词2,...]\n            markerPattern: /\\[kaomoji:([^\\]]+)\\]/gi,\n            // 分隔符\n            keywordSeparator: ',',\n            // 替换策略: 'first' | 'best' | 'all'\n            replaceStrategy: 'best'\n        };\n    }\n\n    /**\n     * 设置配置\n     * @param {Object} config - 配置对象\n     */\n    setConfig(config) {\n        Object.assign(this.config, config);\n    }\n\n    /**\n     * 加载 kaomoji 数据\n     * @param {Array} kaomojis - kaomoji 数据数组\n     */\n    loadKaomojis(kaomojis) {\n        this.searchEngine.buildIndex(kaomojis);\n    }\n\n    /**\n     * 处理文本，替换所有标记为 kaomoji\n     * @param {string} text - 输入文本\n     * @param {Object} options - 替换选项\n     * @returns {Object} 包含替换后的文本和替换信息\n     */\n    replaceText(text, options = {}) {\n        const {\n            strategy = this.config.replaceStrategy,\n            threshold = 0,\n            keepOriginalOnNotFound = true,\n            markNotFound = false\n        } = options;\n\n        let result = text;\n        const replacements = [];\n        let matchIndex = 0;\n\n        // 查找所有标记\n        result = result.replace(this.config.markerPattern, (match, keywordsStr, offset) => {\n            // 解析关键词\n            const keywords = keywordsStr\n                .split(this.config.keywordSeparator)\n                .map(k => k.trim())\n                .filter(k => k.length > 0);\n\n            if (keywords.length === 0) {\n                return keepOriginalOnNotFound ? match : '';\n            }\n\n            // 搜索匹配的 kaomoji\n            const searchText = keywords.join(' ');\n            const matches = this.searchEngine.search(searchText, 5, threshold);\n\n            let replacement = '';\n            let selectedKaomoji = null;\n\n            if (matches.length > 0) {\n                // 根据策略选择 kaomoji\n                switch (strategy) {\n                    case 'first':\n                        selectedKaomoji = matches[0];\n                        replacement = matches[0].kaomoji;\n                        break;\n\n                    case 'best':\n                        // 选择分数最高的\n                        selectedKaomoji = matches[0];\n                        replacement = matches[0].kaomoji;\n                        break;\n\n                    case 'all':\n                        // 返回所有匹配的 kaomoji\n                        replacement = matches.map(m => m.kaomoji).join(' ');\n                        selectedKaomoji = matches;\n                        break;\n\n                    default:\n                        selectedKaomoji = matches[0];\n                        replacement = matches[0].kaomoji;\n                }\n\n                // 记录替换信息\n                replacements.push({\n                    index: matchIndex++,\n                    original: match,\n                    keywords: keywords,\n                    kaomoji: replacement,\n                    offset: offset,\n                    matches: matches,\n                    selected: selectedKaomoji\n                });\n\n                return replacement;\n            } else {\n                // 没有找到匹配的 kaomoji\n                replacements.push({\n                    index: matchIndex++,\n                    original: match,\n                    keywords: keywords,\n                    kaomoji: null,\n                    offset: offset,\n                    matches: [],\n                    selected: null,\n                    notFound: true\n                });\n\n                if (markNotFound) {\n                    return `[?${keywordsStr}]`;\n                }\n\n                return keepOriginalOnNotFound ? match : '';\n            }\n        });\n\n        return {\n            text: result,\n            replacements: replacements,\n            originalText: text,\n            hasReplacements: replacements.length > 0,\n            successCount: replacements.filter(r => !r.notFound).length,\n            failureCount: replacements.filter(r => r.notFound).length\n        };\n    }\n\n    /**\n     * 批量替换多个文本\n     * @param {Array} texts - 文本数组\n     * @param {Object} options - 替换选项\n     * @returns {Array} 替换结果数组\n     */\n    replaceMultiple(texts, options = {}) {\n        return texts.map(text => this.replaceText(text, options));\n    }\n\n    /**\n     * 预览替换结果（不实际替换，只返回会被替换的内容）\n     * @param {string} text - 输入文本\n     * @returns {Array} 预览结果数组\n     */\n    preview(text) {\n        const markers = [];\n        let match;\n\n        const regex = new RegExp(this.config.markerPattern);\n        while ((match = regex.exec(text)) !== null) {\n            const keywordsStr = match[1];\n            const keywords = keywordsStr\n                .split(this.config.keywordSeparator)\n                .map(k => k.trim())\n                .filter(k => k.length > 0);\n\n            const searchText = keywords.join(' ');\n            const matches = this.searchEngine.search(searchText, 5, 0);\n\n            markers.push({\n                marker: match[0],\n                keywords: keywords,\n                offset: match.index,\n                matches: matches,\n                bestMatch: matches.length > 0 ? matches[0] : null\n            });\n        }\n\n        return markers;\n    }\n\n    /**\n     * 查询关键词对应的 kaomoji（不需要标记格式）\n     * @param {string} keywords - 关键词字符串\n     * @param {number} topK - 返回前 K 个结果\n     * @returns {Array} 匹配结果\n     */\n    query(keywords, topK = 5) {\n        return this.searchEngine.search(keywords, topK, 0);\n    }\n\n    /**\n     * 精确查询（使用关键词完全匹配）\n     * @param {string} keywords - 关键词字符串\n     * @returns {Array} 精确匹配结果\n     */\n    exactQuery(keywords) {\n        return this.searchEngine.exactMatch(keywords);\n    }\n\n    /**\n     * 获取统计信息\n     * @returns {Object} 统计数据\n     */\n    getStats() {\n        return {\n            totalKaomojis: this.searchEngine.documents.length,\n            avgDocLength: this.searchEngine.avgDocLength,\n            config: { ...this.config }\n        };\n    }\n}\n\n// ES Modules 导出\nexport default KaomojiReplacer;\n","/**\n * SearchEngine.js\n * 基于 BM25 算法的关键词搜索引擎\n * 用于在文本中查找和评分关键词匹配\n */\n\nclass SearchEngine {\n    constructor(config = {}) {\n        // BM25 参数\n        this.k1 = config.k1 || 1.5;  // 词频饱和参数\n        this.b = config.b || 0.75;   // 长度归一化参数\n        this.charWeight = config.charWeight || 0.6; // 单字匹配权重系数\n\n        // 索引数据\n        this.documents = [];         // 文档列表（每个kaomoji的keywords作为一个文档）\n        this.avgDocLength = 0;       // 平均文档长度（整词）\n        this.avgCharDocLength = 0;   // 平均文档长度（单字）\n        this.idf = new Map();        // 整词IDF值缓存\n        this.charIdf = new Map();    // 单字IDF值缓存\n    }\n\n    /**\n     * 解析关键词权重\n     * @param {string} keywordStr - 关键词字符串（可能包含权重前缀）\n     * @returns {Object} { keyword, weight }\n     */\n    _parseKeywordWeight(keywordStr) {\n        // 匹配格式：权重+关键词（如 \"1.05开心\"、\"0.9悲伤\"）\n        const match = keywordStr.match(/^([0-9]+\\.?[0-9]*)(.+)$/);\n\n        if (match) {\n            const weight = parseFloat(match[1]);\n            const keyword = match[2];\n\n            // 验证权重是否有效（大于0）且关键词非空\n            if (!isNaN(weight) && weight > 0) {\n                return { keyword, weight };\n            }\n        }\n\n        // 默认返回原始字符串和权重1.0\n        return { keyword: keywordStr, weight: 1.0 };\n    }\n\n    /**\n     * 构建索引\n     * @param {Array} kaomojis - kaomoji 数据数组\n     */\n    buildIndex(kaomojis) {\n        this.documents = kaomojis.map(item => {\n            // 解析关键词权重\n            const keywordWeights = new Map(); // 存储关键词到权重的映射\n            const keywords = item.keywords.map(kw => {\n                const { keyword, weight } = this._parseKeywordWeight(kw);\n                keywordWeights.set(keyword, weight);\n                return keyword;\n            });\n\n            // 拆分所有keywords为单字（使用flatMap简化）\n            const chars = keywords.flatMap(keyword => keyword.split(''));\n\n            // 预计算词频以提高搜索性能\n            const keywordFreq = new Map();\n            for (const keyword of keywords) {\n                keywordFreq.set(keyword, (keywordFreq.get(keyword) || 0) + 1);\n            }\n\n            const charFreq = new Map();\n            for (const char of chars) {\n                charFreq.set(char, (charFreq.get(char) || 0) + 1);\n            }\n\n            // 预计算多字关键词\n            const multiCharKeywords = keywords.filter(kw => kw.length >= 2);\n\n            // 预计算倒排索引：单字 -> 包含该单字的多字关键词列表（性能优化）\n            const charToMultiCharKeywords = new Map();\n            multiCharKeywords.forEach(kw => {\n                // 使用 Set 确保每个关键词中的字符只处理一次\n                [...new Set(kw.split(''))].forEach(char => {\n                    if (!charToMultiCharKeywords.has(char)) {\n                        charToMultiCharKeywords.set(char, []);\n                    }\n                    charToMultiCharKeywords.get(char).push(kw);\n                });\n            });\n\n            return {\n                kaomoji: item.kaomoji,\n                keywords: keywords,      // 整词关键词（已解析，不含权重前缀）\n                keywordWeights: keywordWeights,  // 关键词权重Map\n                chars: chars,            // 单字关键词\n                keywordFreq: keywordFreq,  // 整词词频Map\n                charFreq: charFreq,        // 单字词频Map\n                multiCharKeywords: multiCharKeywords,  // 预计算多字关键词\n                charToMultiCharKeywords: charToMultiCharKeywords,  // 倒排索引：单字->多字关键词\n                weight: item.weight || 1.0,\n                category: item.category || ''\n            };\n        });\n\n        // 计算平均文档长度（整词）\n        const totalLength = this.documents.reduce((sum, doc) =>\n            sum + doc.keywords.length, 0);\n        this.avgDocLength = totalLength / this.documents.length;\n\n        // 计算平均文档长度（单字）\n        const totalCharLength = this.documents.reduce((sum, doc) =>\n            sum + doc.chars.length, 0);\n        this.avgCharDocLength = totalCharLength / this.documents.length;\n\n        // 计算整词和单字的IDF\n        this._calculateIDF();\n    }\n\n    /**\n     * 计算 IDF (Inverse Document Frequency)\n     * 分别计算整词和单字的IDF\n     */\n    _calculateIDF() {\n        const termDocCount = new Map();\n        const charDocCount = new Map();\n        const N = this.documents.length;\n\n        // 统计每个整词和单字出现在多少个文档中（合并循环提高效率）\n        this.documents.forEach(doc => {\n            const uniqueTerms = new Set(doc.keywords);\n            uniqueTerms.forEach(term => {\n                termDocCount.set(term, (termDocCount.get(term) || 0) + 1);\n            });\n\n            const uniqueChars = new Set(doc.chars);\n            uniqueChars.forEach(char => {\n                charDocCount.set(char, (charDocCount.get(char) || 0) + 1);\n            });\n        });\n\n        // 计算整词 IDF: log((N - df + 0.5) / (df + 0.5) + 1)\n        termDocCount.forEach((df, term) => {\n            this.idf.set(term, Math.log((N - df + 0.5) / (df + 0.5) + 1));\n        });\n\n        // 计算单字 IDF: log((N - df + 0.5) / (df + 0.5) + 1)\n        charDocCount.forEach((df, char) => {\n            this.charIdf.set(char, Math.log((N - df + 0.5) / (df + 0.5) + 1));\n        });\n    }\n\n    /**\n     * 计算关键词权重\n     * @param {Set} matchedKeywords - 匹配到的关键词集合\n     * @param {Map} keywordWeights - 关键词权重Map\n     * @returns {number} 关键词权重\n     */\n    _calculateKeywordWeight(matchedKeywords, keywordWeights) {\n        if (matchedKeywords.size === 0) {\n            return 1.0;\n        }\n\n        // 单次遍历查找最大和最小权重（性能优化）\n        let maxWeight = -Infinity;\n        let minWeight = Infinity;\n        let hasGreaterThan1 = false;\n        let hasLessThan1 = false;\n\n        for (const kw of matchedKeywords) {\n            const weight = keywordWeights.get(kw) || 1.0;\n            if (weight > 1.0) {\n                maxWeight = Math.max(maxWeight, weight);\n                hasGreaterThan1 = true;\n            } else if (weight < 1.0) {\n                minWeight = Math.min(minWeight, weight);\n                hasLessThan1 = true;\n            }\n        }\n\n        // 如果既有大于1又有小于1，将最大和最小相乘\n        if (hasGreaterThan1 && hasLessThan1) {\n            return maxWeight * minWeight;\n        }\n\n        // 如果都大于1，取最大的\n        if (hasGreaterThan1) {\n            return maxWeight;\n        }\n\n        // 如果都小于1，取最小的\n        if (hasLessThan1) {\n            return minWeight;\n        }\n\n        // 如果只有等于1的，返回1.0\n        return 1.0;\n    }\n\n    /**\n     * 计算 BM25 分数（整词匹配优先 + 单字匹配补充）\n     * @param {Array} queryTerms - 查询词列表\n     * @param {Array} queryChars - 查询单字列表（去重）\n     * @param {Array} singleCharQueries - 单字查询词列表（预提取，避免重复计算）\n     * @param {Object} doc - 文档对象\n     * @returns {number} BM25 分数\n     */\n    _calculateBM25(queryTerms, queryChars, singleCharQueries, doc) {\n        // 1. 整词匹配分数\n        let wholeWordScore = 0;\n        const docLength = doc.keywords.length;\n\n        // 记录哪些单字查询词已经在整词匹配中计分\n        const scoredSingleChars = new Set();\n\n        // 记录匹配到的关键词（用于计算关键词权重）\n        const matchedKeywords = new Set();\n\n        queryTerms.forEach(term => {\n            // 使用预计算的词频Map（避免每次filter）\n            const tf = doc.keywordFreq.get(term) || 0;\n\n            if (tf === 0) return;\n\n            // 记录匹配到的关键词\n            matchedKeywords.add(term);\n\n            // 获取 IDF\n            const idf = this.idf.get(term) || 0;\n\n            // BM25 公式\n            const numerator = tf * (this.k1 + 1);\n            const denominator = tf + this.k1 * (1 - this.b + this.b * (docLength / this.avgDocLength));\n\n            wholeWordScore += idf * (numerator / denominator);\n        });\n\n        // 2. 单字查询词在多字关键词中的匹配（按整词匹配算分）\n        // 使用预提取的单字查询词和预计算的倒排索引（O(1)查找，性能优化）\n        singleCharQueries.forEach(singleChar => {\n            // 通过倒排索引 O(1) 查找包含该单字的所有多字关键词\n            const matchingKeywords = doc.charToMultiCharKeywords.get(singleChar) || [];\n\n            if (matchingKeywords.length > 0) {\n                // 记录匹配到的关键词\n                matchingKeywords.forEach(kw => matchedKeywords.add(kw));\n\n                // 计算该单字在这些多字关键词中的匹配分数\n                // 词频 = 包含该单字的多字关键词的总词频\n                const tf = matchingKeywords.reduce((sum, keyword) =>\n                    sum + (doc.keywordFreq.get(keyword) || 0), 0);\n\n                if (tf > 0) {\n                    // 使用整词的IDF（如果有），否则使用单字的IDF\n                    const idf = this.idf.get(singleChar) || this.charIdf.get(singleChar) || 0;\n\n                    // BM25 公式（使用整词文档长度）\n                    const numerator = tf * (this.k1 + 1);\n                    const denominator = tf + this.k1 * (1 - this.b + this.b * (docLength / this.avgDocLength));\n\n                    wholeWordScore += idf * (numerator / denominator);\n\n                    // 标记该单字已经计分，避免在拆字匹配中重复计分\n                    scoredSingleChars.add(singleChar);\n                }\n            }\n        });\n\n        // 3. 单字匹配分数（排除已经在整词匹配中计分的单字）\n        let charScore = 0;\n        const charDocLength = doc.chars.length;\n\n        // 对单字进行BM25匹配（queryChars已去重，避免重复计分）\n        queryChars.forEach(char => {\n            // 如果该单字已经在整词匹配中计分，跳过\n            if (scoredSingleChars.has(char)) {\n                return;\n            }\n\n            // 使用预计算的单字词频Map\n            const tf = doc.charFreq.get(char) || 0;\n\n            if (tf === 0) return;\n\n            // 获取单字 IDF\n            const idf = this.charIdf.get(char) || 0;\n\n            // BM25 公式\n            const numerator = tf * (this.k1 + 1);\n            const denominator = tf + this.k1 * (1 - this.b + this.b * (charDocLength / this.avgCharDocLength));\n\n            charScore += idf * (numerator / denominator);\n        });\n\n        // 4. 组合分数：整词分数 + 单字分数 × 权重系数\n        const totalScore = wholeWordScore + (charScore * this.charWeight);\n\n        // 5. 计算关键词权重\n        const keywordWeight = this._calculateKeywordWeight(matchedKeywords, doc.keywordWeights);\n\n        // 6. 应用权重：最终得分 = 匹配分数 * 关键词权重 * 颜文字权重\n        return totalScore * keywordWeight * doc.weight;\n    }\n\n    /**\n     * 搜索匹配的 kaomoji\n     * @param {string} text - 要搜索的文本\n     * @param {number} topK - 返回前 K 个结果\n     * @param {number} threshold - 最低分数阈值\n     * @returns {Array} 匹配结果数组\n     */\n    search(text, topK = 5, threshold = 0) {\n        if (!text || this.documents.length === 0) {\n            return [];\n        }\n\n        // 提取查询词（简单分词，可以根据需求优化）\n        const queryTerms = this._tokenize(text);\n\n        if (queryTerms.length === 0) {\n            return [];\n        }\n\n        // 转换为 Set 以提高查找效率 (O(1) vs O(n))\n        const queryTermsSet = new Set(queryTerms);\n\n        // 提取并去重查询单字（避免重复计分和重复计算）\n        const queryChars = [...new Set(queryTerms.flatMap(term => term.split('')))];\n\n        // 提取单字查询词（避免在每个文档中重复计算）\n        const singleCharQueries = queryTerms.filter(term => term.length === 1);\n\n        // 计算每个文档的分数\n        const results = this.documents.map(doc => ({\n            kaomoji: doc.kaomoji,\n            score: this._calculateBM25(queryTerms, queryChars, singleCharQueries, doc),\n            matchedKeywords: doc.keywords.filter(k => queryTermsSet.has(k)),\n            category: doc.category\n        }));\n\n        // 过滤、排序并返回 top K\n        // 注意：现在即使没有整词匹配，单字匹配也可能有分数，所以只检查 score > threshold\n        return results\n            .filter(r => r.score > threshold)\n            .map(item => ({ item, random: Math.random() }))\n            .sort((a, b) => (b.item.score - a.item.score) || (a.random - b.random))\n            .map(({ item }) => item)\n            .slice(0, topK);\n    }\n\n    /**\n     * 简单分词函数\n     * @param {string} text - 输入文本\n     * @returns {Array} 词列表\n     */\n    _tokenize(text) {\n        // 移除空格和标点\n        const cleaned = text.replace(/[^\\u4e00-\\u9fa5a-zA-Z0-9]/g, ' ');\n\n        // 简单按空格分词（对于中文需要更复杂的分词，但这里保持简单）\n        // 也包含所有可能的子串（对于短文本）\n        const words = cleaned.split(/\\s+/).filter(w => w.length > 0);\n\n        // 对于中文，额外提取所有连续字符组合\n        const chineseChars = text.match(/[\\u4e00-\\u9fa5]+/g) || [];\n        chineseChars.forEach(chunk => {\n            // 提取所有可能的词组合（2-4字）\n            for (let len = 2; len <= Math.min(4, chunk.length); len++) {\n                for (let i = 0; i <= chunk.length - len; i++) {\n                    words.push(chunk.slice(i, i + len));\n                }\n            }\n            // 也加入单字\n            for (let char of chunk) {\n                words.push(char);\n            }\n        });\n\n        return [...new Set(words)]; // 去重\n    }\n\n    /**\n     * 精确匹配关键词\n     * @param {string} text - 输入文本\n     * @returns {Array} 精确匹配的结果\n     */\n    exactMatch(text) {\n        const results = [];\n\n        this.documents.forEach(doc => {\n            const matchedKeywords = doc.keywords.filter(keyword =>\n                text.includes(keyword)\n            );\n\n            if (matchedKeywords.length > 0) {\n                // 计算关键词权重\n                const matchedKeywordsSet = new Set(matchedKeywords);\n                const keywordWeight = this._calculateKeywordWeight(matchedKeywordsSet, doc.keywordWeights);\n\n                // 计算得分：匹配数量 * 关键词权重 * 颜文字权重\n                const score = matchedKeywords.length * keywordWeight * doc.weight;\n\n                results.push({\n                    kaomoji: doc.kaomoji,\n                    matchedKeywords: matchedKeywords,\n                    score: score,\n                    category: doc.category\n                });\n            }\n        });\n\n        return results\n            .map(item => ({ item, random: Math.random() }))\n            .sort((a, b) => (b.item.score - a.item.score) || (a.random - b.random))\n            .map(({ item }) => item);\n    }\n}\n\n// ES Modules 导出\nexport default SearchEngine;\n","/**\n * KaomojiDataManager.js\n * 颜文字数据管理类 - 完整 CRUD\n */\n\nclass KaomojiDataManager {\n    constructor() {\n        this.kaomojis = [];\n    }\n\n    // ========== 数据加载 ==========\n\n    /**\n     * 从 JSON 字符串加载数据\n     * @param {string} jsonString - JSON 字符串\n     * @returns {KaomojiDataManager} 链式调用\n     */\n    loadFromJSON(jsonString) {\n        try {\n            const data = JSON.parse(jsonString);\n            return this.loadFromArray(data);\n        } catch (error) {\n            console.error('Failed to parse JSON:', error);\n            throw new Error('Invalid JSON format');\n        }\n    }\n\n    /**\n     * 从对象数组加载数据\n     * @param {Array} data - 颜文字数据数组\n     * @returns {KaomojiDataManager} 链式调用\n     */\n    loadFromArray(data) {\n        if (!Array.isArray(data)) {\n            throw new Error('Data must be an array');\n        }\n\n        this.kaomojis = [];\n        data.forEach((item, index) => {\n            if (this._validateItem(item, index)) {\n                this.kaomojis.push(this._normalizeItem(item));\n            }\n        });\n\n        console.log(`Loaded ${this.kaomojis.length} kaomojis`);\n        return this;\n    }\n\n    /**\n     * 验证数据项\n     * @private\n     */\n    _validateItem(item, index) {\n        if (!item.kaomoji || typeof item.kaomoji !== 'string') {\n            console.warn(`Item ${index}: Missing or invalid 'kaomoji' field, skipping`);\n            return false;\n        }\n\n        if (!item.keywords || !Array.isArray(item.keywords) || item.keywords.length === 0) {\n            console.warn(`Item ${index}: Missing or invalid 'keywords' field, skipping`);\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * 规范化数据项\n     * @private\n     */\n    _normalizeItem(item) {\n        return {\n            kaomoji: item.kaomoji,\n            keywords: item.keywords.map(k => String(k).trim()).filter(k => k.length > 0),\n            weight: typeof item.weight === 'number' ? item.weight : 1.0,\n            category: item.category || ''\n        };\n    }\n\n    /**\n     * 深拷贝单个颜文字对象\n     * @private\n     * @param {Object} item - 颜文字对象\n     * @returns {Object} 深拷贝的对象\n     */\n    _deepCopy(item) {\n        return {\n            kaomoji: item.kaomoji,\n            keywords: [...item.keywords],\n            weight: item.weight,\n            category: item.category\n        };\n    }\n\n    // ========== 读取操作 ==========\n\n    /**\n     * 获取所有颜文字（深拷贝）\n     * @returns {Array} 颜文字数组的深拷贝\n     */\n    getAllKaomojis() {\n        return this.kaomojis.map(item => this._deepCopy(item));\n    }\n\n    /**\n     * 通过颜文字文本查找（深拷贝）\n     * @param {string} kaomoji - 颜文字文本\n     * @returns {Object|null} 颜文字对象的深拷贝，未找到返回 null\n     */\n    getKaomojiByText(kaomoji) {\n        const found = this.kaomojis.find(item => item.kaomoji === kaomoji);\n        return found ? this._deepCopy(found) : null;\n    }\n\n    /**\n     * 获取所有关键词列表（去重）\n     * @returns {Array} 关键词数组\n     */\n    getAllKeywords() {\n        const keywords = new Set();\n        this.kaomojis.forEach(item => {\n            item.keywords.forEach(keyword => keywords.add(keyword));\n        });\n        return Array.from(keywords).sort();\n    }\n\n    /**\n     * 获取特定颜文字的关键词\n     * @param {string} kaomoji - 颜文字文本\n     * @returns {Array} 关键词数组，未找到返回空数组\n     */\n    getKeywordsByKaomoji(kaomoji) {\n        const item = this.kaomojis.find(e => e.kaomoji === kaomoji);\n        return item ? [...item.keywords] : [];\n    }\n\n    /**\n     * 按分类筛选（深拷贝）\n     * @param {string|Array} category - 分类名称或分类数组\n     * @returns {Array} 筛选后的颜文字数组的深拷贝\n     */\n    filterByCategory(category) {\n        const categories = Array.isArray(category) ? category : [category];\n        return this.kaomojis\n            .filter(item => categories.includes(item.category))\n            .map(item => this._deepCopy(item));\n    }\n\n    /**\n     * 获取所有分类列表（去重）\n     * @returns {Array} 分类数组\n     */\n    getAllCategories() {\n        const categories = new Set();\n        this.kaomojis.forEach(item => {\n            if (item.category) {\n                categories.add(item.category);\n            }\n        });\n        return Array.from(categories).sort();\n    }\n\n    /**\n     * 搜索包含特定关键词的颜文字（深拷贝）\n     * @param {string|Array} keyword - 关键词或关键词数组（多个关键词使用 AND 逻辑）\n     * @returns {Array} 包含该关键词的颜文字数组的深拷贝\n     */\n    findByKeyword(keyword) {\n        const keywords = (Array.isArray(keyword) ? keyword : [keyword])\n            .map(k => String(k || '').trim())\n            .filter(k => k.length > 0);\n\n        if (keywords.length === 0) {\n            return [];\n        }\n\n        return this.kaomojis\n            .filter(item => keywords.every(k => item.keywords.includes(k)))\n            .map(item => this._deepCopy(item));\n    }\n\n    /**\n     * 获取数据统计信息\n     * @returns {Object} 统计数据\n     */\n    getStats() {\n        return {\n            totalKaomojis: this.kaomojis.length,\n            totalKeywords: this.getAllKeywords().length,\n            totalCategories: this.getAllCategories().length,\n            averageKeywordsPerKaomoji: this.kaomojis.length > 0\n                ? this.kaomojis.reduce((sum, e) => sum + e.keywords.length, 0) / this.kaomojis.length\n                : 0\n        };\n    }\n\n    // ========== 修改操作 ==========\n\n    /**\n     * 添加关键词\n     * @param {string} kaomoji - 颜文字文本\n     * @param {string} keyword - 要添加的关键词\n     * @returns {boolean} 是否成功\n     */\n    addKeyword(kaomoji, keyword) {\n        const item = this.kaomojis.find(e => e.kaomoji === kaomoji);\n        if (!item) {\n            console.warn(`Kaomoji \"${kaomoji}\" not found`);\n            return false;\n        }\n\n        const trimmedKeyword = String(keyword).trim();\n        if (!trimmedKeyword) {\n            console.warn('Keyword cannot be empty');\n            return false;\n        }\n\n        if (item.keywords.includes(trimmedKeyword)) {\n            console.warn(`Keyword \"${trimmedKeyword}\" already exists`);\n            return false;\n        }\n\n        item.keywords.push(trimmedKeyword);\n        return true;\n    }\n\n    /**\n     * 删除关键词\n     * @param {string} kaomoji - 颜文字文本\n     * @param {string} keyword - 要删除的关键词\n     * @returns {boolean} 是否成功\n     */\n    removeKeyword(kaomoji, keyword) {\n        const item = this.kaomojis.find(e => e.kaomoji === kaomoji);\n        if (!item) {\n            console.warn(`Kaomoji \"${kaomoji}\" not found`);\n            return false;\n        }\n\n        const index = item.keywords.indexOf(keyword);\n        if (index === -1) {\n            console.warn(`Keyword \"${keyword}\" not found`);\n            return false;\n        }\n\n        if (item.keywords.length <= 1) {\n            console.warn('Cannot remove the last keyword');\n            return false;\n        }\n\n        item.keywords.splice(index, 1);\n        return true;\n    }\n\n    /**\n     * 批量更新关键词\n     * @param {string} kaomoji - 颜文字文本\n     * @param {Array} keywords - 新的关键词数组\n     * @returns {boolean} 是否成功\n     */\n    updateKeywords(kaomoji, keywords) {\n        const item = this.kaomojis.find(e => e.kaomoji === kaomoji);\n        if (!item) {\n            console.warn(`Kaomoji \"${kaomoji}\" not found`);\n            return false;\n        }\n\n        if (!Array.isArray(keywords) || keywords.length === 0) {\n            console.warn('Keywords must be a non-empty array');\n            return false;\n        }\n\n        const validKeywords = keywords\n            .map(k => String(k).trim())\n            .filter(k => k.length > 0);\n\n        if (validKeywords.length === 0) {\n            console.warn('No valid keywords provided');\n            return false;\n        }\n\n        item.keywords = validKeywords;\n        return true;\n    }\n\n    /**\n     * 设置分类\n     * @param {string} kaomoji - 颜文字文本\n     * @param {string} category - 分类名称\n     * @returns {boolean} 是否成功\n     */\n    setCategory(kaomoji, category) {\n        const item = this.kaomojis.find(e => e.kaomoji === kaomoji);\n        if (!item) {\n            console.warn(`Kaomoji \"${kaomoji}\" not found`);\n            return false;\n        }\n\n        item.category = category || '';\n        return true;\n    }\n\n    /**\n     * 设置权重\n     * @param {string} kaomoji - 颜文字文本\n     * @param {number} weight - 权重值\n     * @returns {boolean} 是否成功\n     */\n    setWeight(kaomoji, weight) {\n        const item = this.kaomojis.find(e => e.kaomoji === kaomoji);\n        if (!item) {\n            console.warn(`Kaomoji \"${kaomoji}\" not found`);\n            return false;\n        }\n\n        if (typeof weight !== 'number' || weight <= 0) {\n            console.warn('Weight must be a positive number');\n            return false;\n        }\n\n        item.weight = weight;\n        return true;\n    }\n\n    // ========== 颜文字管理 ==========\n\n    /**\n     * 添加新颜文字\n     * @param {Object} data - 颜文字数据 { kaomoji, keywords, weight?, category? }\n     * @returns {boolean} 是否成功\n     */\n    addKaomoji(data) {\n        if (!this._validateItem(data, 'new')) {\n            return false;\n        }\n\n        // 检查是否已存在\n        if (this.kaomojis.find(e => e.kaomoji === data.kaomoji)) {\n            console.warn(`Kaomoji \"${data.kaomoji}\" already exists`);\n            return false;\n        }\n\n        this.kaomojis.push(this._normalizeItem(data));\n        return true;\n    }\n\n    /**\n     * 删除颜文字\n     * @param {string} kaomoji - 颜文字文本\n     * @returns {boolean} 是否成功\n     */\n    removeKaomoji(kaomoji) {\n        const index = this.kaomojis.findIndex(e => e.kaomoji === kaomoji);\n        if (index === -1) {\n            console.warn(`Kaomoji \"${kaomoji}\" not found`);\n            return false;\n        }\n\n        this.kaomojis.splice(index, 1);\n        return true;\n    }\n\n    /**\n     * 更新颜文字完整数据\n     * @param {string} kaomoji - 原颜文字文本\n     * @param {Object} newData - 新数据\n     * @returns {boolean} 是否成功\n     */\n    updateKaomoji(kaomoji, newData) {\n        const index = this.kaomojis.findIndex(e => e.kaomoji === kaomoji);\n        if (index === -1) {\n            console.warn(`Kaomoji \"${kaomoji}\" not found`);\n            return false;\n        }\n\n        if (!this._validateItem(newData, 'update')) {\n            return false;\n        }\n\n        // 如果更改了 kaomoji 文本，检查新文本是否已存在\n        if (newData.kaomoji !== kaomoji) {\n            if (this.kaomojis.find(e => e.kaomoji === newData.kaomoji)) {\n                console.warn(`Kaomoji \"${newData.kaomoji}\" already exists`);\n                return false;\n            }\n        }\n\n        this.kaomojis[index] = this._normalizeItem(newData);\n        return true;\n    }\n\n    // ========== 数据导出 ==========\n\n    /**\n     * 导出为 JSON 字符串\n     * @param {boolean} pretty - 是否格式化输出\n     * @returns {string} JSON 字符串\n     */\n    exportToJSON(pretty = true) {\n        return JSON.stringify(this.kaomojis, null, pretty ? 2 : 0);\n    }\n\n    /**\n     * 导出为对象数组\n     * @returns {Array} 颜文字数组的深拷贝\n     */\n    exportToArray() {\n        return this.kaomojis.map(item => ({ ...item, keywords: [...item.keywords] }));\n    }\n\n    // ========== 批量操作 ==========\n\n    /**\n     * 批量修改分类\n     * @param {Array} kaomojis - 颜文字文本数组\n     * @param {string} category - 分类名称\n     * @returns {number} 成功修改的数量\n     */\n    batchSetCategory(kaomojis, category) {\n        let count = 0;\n        kaomojis.forEach(kaomoji => {\n            if (this.setCategory(kaomoji, category)) {\n                count++;\n            }\n        });\n        return count;\n    }\n\n    /**\n     * 批量删除颜文字\n     * @param {Array} kaomojis - 颜文字文本数组\n     * @returns {number} 成功删除的数量\n     */\n    batchRemove(kaomojis) {\n        let count = 0;\n        kaomojis.forEach(kaomoji => {\n            if (this.removeKaomoji(kaomoji)) {\n                count++;\n            }\n        });\n        return count;\n    }\n\n    /**\n     * 清空所有数据\n     */\n    clear() {\n        this.kaomojis = [];\n    }\n}\n\n// ES Modules 导出\nexport default KaomojiDataManager;\n","/**\n * IndexedDBStorage.js\n * 前端 IndexedDB 存储管理\n * 用于在浏览器中持久化颜文字数据\n */\n\nconst DB_NAME = 'KaomojiReplacerDB';\nconst DB_VERSION = 1;\nconst STORE_NAME = 'kaomojis';\nconst DATA_KEY = 'kaomoji_data';\n\n// 调试开关（默认关闭）\nlet DEBUG_MODE = false;\n\n/**\n * 设置调试模式\n * @param {boolean} enabled - 是否启用调试模式\n */\nfunction setDebugMode(enabled) {\n    DEBUG_MODE = enabled;\n}\n\n/**\n * 调试日志（仅在调试模式开启时输出）\n */\nfunction debugLog(message, ...args) {\n    if (DEBUG_MODE) {\n        console.log(`[KaomojiReplacer] ${message}`, ...args);\n    }\n}\n\nfunction debugWarn(message, ...args) {\n    if (DEBUG_MODE) {\n        console.warn(`[KaomojiReplacer] ${message}`, ...args);\n    }\n}\n\nfunction debugError(message, ...args) {\n    // 错误总是输出，但在非调试模式下简化\n    if (DEBUG_MODE) {\n        console.error(`[KaomojiReplacer] ${message}`, ...args);\n    } else {\n        console.error(`[KaomojiReplacer] ${message}`);\n    }\n}\n\n/**\n * 打开 IndexedDB 连接\n * @returns {Promise<IDBDatabase>}\n */\nfunction openDatabase() {\n    return new Promise((resolve, reject) => {\n        if (typeof indexedDB === 'undefined') {\n            reject(new Error('IndexedDB is not supported in this environment'));\n            return;\n        }\n\n        const request = indexedDB.open(DB_NAME, DB_VERSION);\n\n        request.onerror = () => {\n            reject(new Error('Failed to open IndexedDB'));\n        };\n\n        request.onsuccess = () => {\n            resolve(request.result);\n        };\n\n        request.onupgradeneeded = (event) => {\n            const db = event.target.result;\n\n            // 创建对象存储\n            if (!db.objectStoreNames.contains(STORE_NAME)) {\n                db.createObjectStore(STORE_NAME);\n            }\n        };\n    });\n}\n\n/**\n * 从 IndexedDB 读取颜文字数据\n * @returns {Promise<Array|null>} 颜文字数组，不存在返回 null\n */\nasync function getKaomojis() {\n    try {\n        const db = await openDatabase();\n\n        return new Promise((resolve, reject) => {\n            const transaction = db.transaction([STORE_NAME], 'readonly');\n            const store = transaction.objectStore(STORE_NAME);\n            const request = store.get(DATA_KEY);\n\n            transaction.oncomplete = () => {\n                db.close();\n            };\n\n            transaction.onerror = () => {\n                db.close();\n                reject(new Error('Transaction failed'));\n            };\n\n            request.onsuccess = () => {\n                resolve(request.result || null);\n            };\n\n            request.onerror = () => {\n                reject(new Error('Failed to read from IndexedDB'));\n            };\n        });\n    } catch (error) {\n        debugError('Error reading from IndexedDB:', error);\n        return null;\n    }\n}\n\n/**\n * 保存颜文字数据到 IndexedDB\n * @param {Array} data - 颜文字数组\n * @returns {Promise<boolean>} 是否成功\n */\nasync function saveKaomojis(data) {\n    if (!Array.isArray(data)) {\n        debugError('Data must be an array');\n        return false;\n    }\n\n    try {\n        const db = await openDatabase();\n\n        return new Promise((resolve, reject) => {\n            const transaction = db.transaction([STORE_NAME], 'readwrite');\n            const store = transaction.objectStore(STORE_NAME);\n            const request = store.put(data, DATA_KEY);\n\n            transaction.oncomplete = () => {\n                db.close();\n                debugLog(`Saved ${data.length} kaomojis to IndexedDB`);\n                resolve(true);\n            };\n\n            transaction.onerror = () => {\n                db.close();\n                reject(new Error('Transaction failed'));\n            };\n\n            request.onerror = () => {\n                reject(new Error('Failed to save to IndexedDB'));\n            };\n        });\n    } catch (error) {\n        debugError('Error saving to IndexedDB:', error);\n        return false;\n    }\n}\n\n/**\n * 清空 IndexedDB 中的颜文字数据\n * @returns {Promise<boolean>} 是否成功\n */\nasync function clearKaomojis() {\n    try {\n        const db = await openDatabase();\n\n        return new Promise((resolve, reject) => {\n            const transaction = db.transaction([STORE_NAME], 'readwrite');\n            const store = transaction.objectStore(STORE_NAME);\n            const request = store.delete(DATA_KEY);\n\n            transaction.oncomplete = () => {\n                db.close();\n                debugLog('Cleared kaomojis from IndexedDB');\n                resolve(true);\n            };\n\n            transaction.onerror = () => {\n                db.close();\n                reject(new Error('Transaction failed'));\n            };\n\n            request.onerror = () => {\n                reject(new Error('Failed to clear IndexedDB'));\n            };\n        });\n    } catch (error) {\n        debugError('Error clearing IndexedDB:', error);\n        return false;\n    }\n}\n\n/**\n * 从远程 URL 加载默认数据\n * @param {string} url - 数据 URL\n * @returns {Promise<Array|null>} 颜文字数组，失败返回 null\n */\nasync function loadFromRemote(url) {\n    try {\n        const response = await fetch(url);\n\n        if (!response.ok) {\n            debugWarn(`Failed to fetch from ${url}: ${response.status}`);\n            return null;\n        }\n\n        const data = await response.json();\n\n        if (!Array.isArray(data)) {\n            debugWarn('Remote data is not an array');\n            return null;\n        }\n\n        return data;\n    } catch (error) {\n        debugWarn('Failed to load from remote:', error);\n        return null;\n    }\n}\n\n/**\n * 初始化颜文字存储\n * - 如果 IndexedDB 中已有数据，直接返回\n * - 如果没有，尝试从远程 URL 加载并保存\n * - 远程加载失败则返回空数组\n *\n * @param {Object} options - 配置选项\n * @param {string} options.defaultURL - 默认数据的远程 URL\n * @param {boolean} options.forceReload - 是否强制重新加载（忽略缓存）\n * @returns {Promise<Array>} 颜文字数组\n */\nasync function initKaomojiStorage(options = {}) {\n    const {\n        defaultURL = null,\n        forceReload = false\n    } = options;\n\n    try {\n        // 检查 IndexedDB 是否已有数据\n        if (!forceReload) {\n            const existingData = await getKaomojis();\n            if (existingData && existingData.length > 0) {\n                debugLog(`Loaded ${existingData.length} kaomojis from IndexedDB cache`);\n                return existingData;\n            }\n        }\n\n        // 如果没有数据且提供了远程 URL，尝试加载\n        if (defaultURL) {\n            debugLog(`Loading default kaomojis from ${defaultURL}...`);\n            const remoteData = await loadFromRemote(defaultURL);\n\n            if (remoteData && remoteData.length > 0) {\n                // 保存到 IndexedDB\n                await saveKaomojis(remoteData);\n                debugLog(`Initialized with ${remoteData.length} kaomojis from remote`);\n                return remoteData;\n            } else {\n                debugWarn('Failed to load from remote, returning empty array');\n            }\n        }\n\n        // 返回空数组\n        return [];\n    } catch (error) {\n        debugError('Error initializing kaomoji storage:', error);\n        return [];\n    }\n}\n\n/**\n * 获取存储统计信息\n * @returns {Promise<Object>} 统计信息\n */\nasync function getStorageStats() {\n    try {\n        const data = await getKaomojis();\n\n        return {\n            hasData: data !== null,\n            count: data ? data.length : 0,\n            sizeKB: data ? (JSON.stringify(data).length / 1024).toFixed(2) : '0.00'\n        };\n    } catch (error) {\n        return {\n            hasData: false,\n            count: 0,\n            sizeKB: 0,\n            error: error.message\n        };\n    }\n}\n\n// ES Modules 导出\nexport {\n    initKaomojiStorage,\n    getKaomojis,\n    saveKaomojis,\n    clearKaomojis,\n    getStorageStats,\n    setDebugMode\n};\n","/**\n * Kaomoji Replacer - Unified API Entry Point\n *\n * 提供多种导入和使用方式：\n * 1. 类导入：const { KaomojiReplacer, SearchEngine, KaomojiDataManager } = require('kaomoji-replacer');\n * 2. 工厂函数：const { createReplacer, createManager } = require('kaomoji-replacer');\n * 3. 快捷 API：const { quickReplace } = require('kaomoji-replacer');\n */\n\n// 导入核心类\nimport KaomojiReplacer from './src/core/KaomojiReplacer.js';\nimport SearchEngine from './src/core/SearchEngine.js';\nimport KaomojiDataManager from './src/core/KaomojiDataManager.js';\n\n// 导入存储模块\nimport * as IndexedDBStorage from './src/storage/IndexedDBStorage.js';\n\n// ========== 工厂函数 ==========\n\n/**\n * 创建一个完整配置的 KaomojiReplacer 实例\n * @param {Object} options - 配置选项\n * @param {Array} options.kaomojis - 颜文字数据数组\n * @param {string} options.jsonData - JSON 格式的颜文字数据\n * @param {Object} options.searchConfig - SearchEngine 配置 { k1, b }\n * @param {Object} options.replaceConfig - KaomojiReplacer 配置\n * @returns {KaomojiReplacer} 配置好的 KaomojiReplacer 实例\n */\nfunction createReplacer(options = {}) {\n    const {\n        kaomojis = [],\n        jsonData = null,\n        searchConfig = {},\n        replaceConfig = {}\n    } = options;\n\n    // 创建搜索引擎\n    const searchEngine = new SearchEngine(searchConfig);\n\n    // 创建替换器\n    const replacer = new KaomojiReplacer(searchEngine);\n\n    // 应用配置\n    if (replaceConfig) {\n        replacer.setConfig(replaceConfig);\n    }\n\n    // 加载数据\n    if (jsonData) {\n        const manager = new KaomojiDataManager();\n        manager.loadFromJSON(jsonData);\n        replacer.loadKaomojis(manager.getAllKaomojis());\n    } else if (kaomojis.length > 0) {\n        replacer.loadKaomojis(kaomojis);\n    }\n\n    return replacer;\n}\n\n/**\n * 创建 KaomojiDataManager 实例并加载数据\n * @param {Array|string} data - 颜文字数据数组或 JSON 字符串\n * @returns {KaomojiDataManager} 加载好数据的 KaomojiDataManager 实例\n */\nfunction createManager(data = null) {\n    const manager = new KaomojiDataManager();\n\n    if (data) {\n        if (typeof data === 'string') {\n            manager.loadFromJSON(data);\n        } else if (Array.isArray(data)) {\n            manager.loadFromArray(data);\n        }\n    }\n\n    return manager;\n}\n\n/**\n * 创建 SearchEngine 实例\n * @param {Object} config - BM25 配置 { k1, b }\n * @returns {SearchEngine} SearchEngine 实例\n */\nfunction createSearchEngine(config = {}) {\n    return new SearchEngine(config);\n}\n\n// ========== 快捷 API ==========\n\n/**\n * 快速替换文本（一站式 API）\n * @param {string} text - 要处理的文本\n * @param {Array|string} kaomojis - 颜文字数据（数组或 JSON 字符串）\n * @param {Object} options - 替换选项\n * @returns {Object} 替换结果\n */\nfunction quickReplace(text, kaomojis, options = {}) {\n    const replacer = createReplacer({\n        kaomojis: Array.isArray(kaomojis) ? kaomojis : [],\n        jsonData: typeof kaomojis === 'string' ? kaomojis : null,\n        searchConfig: options.searchConfig,\n        replaceConfig: options.replaceConfig\n    });\n\n    return replacer.replaceText(text, options);\n}\n\n/**\n * 快速查询关键词对应的颜文字\n * @param {string} keywords - 关键词\n * @param {Array|string} kaomojis - 颜文字数据\n * @param {number} topK - 返回前 K 个结果\n * @returns {Array} 匹配结果\n */\nfunction quickQuery(keywords, kaomojis, topK = 5) {\n    const replacer = createReplacer({\n        kaomojis: Array.isArray(kaomojis) ? kaomojis : [],\n        jsonData: typeof kaomojis === 'string' ? kaomojis : null\n    });\n\n    return replacer.query(keywords, topK);\n}\n\n/**\n * 从文件路径加载颜文字数据（仅 Node.js 环境）\n * @param {string} filePath - 文件路径\n * @returns {Promise<Array>} 颜文字数据数组\n */\nasync function loadFromFile(filePath) {\n    // 检查是否在 Node.js 环境\n    if (typeof process === 'undefined') {\n        throw new Error('loadFromFile is only available in Node.js environment');\n    }\n\n    const { promises: fs } = await import('fs');\n    const fileContent = await fs.readFile(filePath, 'utf8');\n    const manager = new KaomojiDataManager();\n    manager.loadFromJSON(fileContent);\n    return manager.getAllKaomojis();\n}\n\n/**\n * 从 URL 加载颜文字数据（浏览器环境）\n * @param {string} url - 数据 URL\n * @returns {Promise<Array>} 颜文字数据数组\n */\nasync function loadFromURL(url) {\n    const response = await fetch(url);\n\n    if (!response.ok) {\n        throw new Error(`Failed to load from URL: ${response.status} ${response.statusText}`);\n    }\n\n    const jsonText = await response.text();\n    const manager = new KaomojiDataManager();\n    manager.loadFromJSON(jsonText);\n    return manager.getAllKaomojis();\n}\n\n// ========== 工具函数 ==========\n\n/**\n * 验证颜文字数据格式\n * @param {Array} data - 颜文字数据数组\n * @returns {Object} 验证结果 { valid, errors }\n */\nfunction validateData(data) {\n    const errors = [];\n\n    if (!Array.isArray(data)) {\n        return { valid: false, errors: ['Data must be an array'] };\n    }\n\n    data.forEach((item, index) => {\n        if (typeof item !== 'object' || item === null) {\n            errors.push(`Item ${index}: Must be an object.`);\n            return;\n        }\n\n        if (!item.kaomoji || typeof item.kaomoji !== 'string') {\n            errors.push(`Item ${index}: Missing or invalid 'kaomoji' field`);\n        }\n\n        if (!item.keywords || !Array.isArray(item.keywords) || item.keywords.length === 0) {\n            errors.push(`Item ${index}: Missing or invalid 'keywords' field`);\n        }\n\n        if (item.weight !== undefined && (typeof item.weight !== 'number' || item.weight <= 0)) {\n            errors.push(`Item ${index}: Invalid 'weight' field (must be positive number)`);\n        }\n    });\n\n    return {\n        valid: errors.length === 0,\n        errors\n    };\n}\n\n/**\n * 批量处理文本数组\n * @param {Array<string>} texts - 文本数组\n * @param {Array|string} kaomojis - 颜文字数据\n * @param {Object} options - 替换选项\n * @returns {Array} 处理结果数组\n */\nfunction batchReplace(texts, kaomojis, options = {}) {\n    const replacer = createReplacer({\n        kaomojis: Array.isArray(kaomojis) ? kaomojis : [],\n        jsonData: typeof kaomojis === 'string' ? kaomojis : null,\n        searchConfig: options.searchConfig,\n        replaceConfig: options.replaceConfig\n    });\n\n    return replacer.replaceMultiple(texts, options);\n}\n\n// ========== 常量 ==========\n\nconst VERSION = '1.2.2';\n\nconst DEFAULT_CONFIG = {\n    search: {\n        k1: 1.5,\n        b: 0.75\n    },\n    replace: {\n        markerPattern: /\\[kaomoji:([^\\]]+)\\]/gi,\n        keywordSeparator: ',',\n        replaceStrategy: 'best'\n    }\n};\n\nconst REPLACE_STRATEGIES = {\n    FIRST: 'first',    // 使用第一个匹配结果\n    BEST: 'best',      // 使用最佳匹配结果（默认）\n    ALL: 'all'         // 返回所有匹配结果\n};\n\n// ========== 导出 ==========\n\nexport {\n    // 核心类\n    KaomojiReplacer,\n    SearchEngine,\n    KaomojiDataManager,\n\n    // 工厂函数\n    createReplacer,\n    createManager,\n    createSearchEngine,\n\n    // 快捷 API\n    quickReplace,\n    quickQuery,\n\n    // 数据加载\n    loadFromFile,\n    loadFromURL,\n\n    // 工具函数\n    validateData,\n    batchReplace,\n\n    // 存储 API (IndexedDB)\n    IndexedDBStorage,\n\n    // 常量\n    VERSION,\n    DEFAULT_CONFIG,\n    REPLACE_STRATEGIES\n};\n\n// 导出 IndexedDB 存储函数（解构便于使用）\nexport const {\n    initKaomojiStorage,\n    getKaomojis,\n    saveKaomojis,\n    clearKaomojis,\n    getStorageStats,\n    setDebugMode\n} = IndexedDBStorage;\n"],"names":["KaomojiReplacer","constructor","searchEngine","this","config","markerPattern","keywordSeparator","replaceStrategy","setConfig","Object","assign","loadKaomojis","kaomojis","buildIndex","replaceText","text","options","strategy","threshold","keepOriginalOnNotFound","markNotFound","result","replacements","matchIndex","replace","match","keywordsStr","offset","keywords","split","map","k","trim","filter","length","searchText","join","matches","search","replacement","selectedKaomoji","kaomoji","m","push","index","original","selected","notFound","originalText","hasReplacements","successCount","r","failureCount","replaceMultiple","texts","preview","markers","regex","RegExp","exec","marker","bestMatch","query","topK","exactQuery","exactMatch","getStats","totalKaomojis","documents","avgDocLength","SearchEngine","k1","b","charWeight","avgCharDocLength","idf","Map","charIdf","_parseKeywordWeight","keywordStr","weight","parseFloat","keyword","isNaN","item","keywordWeights","kw","set","chars","flatMap","keywordFreq","get","charFreq","char","multiCharKeywords","charToMultiCharKeywords","forEach","Set","has","category","totalLength","reduce","sum","doc","totalCharLength","_calculateIDF","termDocCount","charDocCount","N","term","df","Math","log","_calculateKeywordWeight","matchedKeywords","size","maxWeight","Infinity","minWeight","hasGreaterThan1","hasLessThan1","max","min","_calculateBM25","queryTerms","queryChars","singleCharQueries","wholeWordScore","docLength","scoredSingleChars","tf","add","singleChar","matchingKeywords","charScore","charDocLength","_tokenize","queryTermsSet","score","random","sort","a","slice","words","w","chunk","len","i","results","includes","matchedKeywordsSet","keywordWeight","KaomojiDataManager","loadFromJSON","jsonString","data","JSON","parse","loadFromArray","error","console","Error","Array","isArray","_validateItem","_normalizeItem","warn","String","_deepCopy","getAllKaomojis","getKaomojiByText","found","find","getAllKeywords","from","getKeywordsByKaomoji","e","filterByCategory","categories","getAllCategories","findByKeyword","every","totalKeywords","totalCategories","averageKeywordsPerKaomoji","addKeyword","trimmedKeyword","removeKeyword","indexOf","splice","updateKeywords","validKeywords","setCategory","setWeight","addKaomoji","removeKaomoji","findIndex","updateKaomoji","newData","exportToJSON","pretty","stringify","exportToArray","batchSetCategory","count","batchRemove","clear","STORE_NAME","DATA_KEY","DEBUG_MODE","debugLog","message","args","debugWarn","debugError","openDatabase","Promise","resolve","reject","indexedDB","request","open","onerror","onsuccess","onupgradeneeded","event","db","target","objectStoreNames","contains","createObjectStore","async","getKaomojis","transaction","objectStore","oncomplete","close","saveKaomojis","put","delete","hasData","sizeKB","toFixed","defaultURL","forceReload","existingData","remoteData","url","response","fetch","ok","status","json","loadFromRemote","enabled","createReplacer","jsonData","searchConfig","replaceConfig","replacer","manager","initKaomojiStorage","clearKaomojis","getStorageStats","setDebugMode","IndexedDBStorage","FIRST","BEST","ALL","filePath","process","promises","fs","import","fileContent","readFile","statusText","jsonText","errors","undefined","valid"],"mappings":"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"}