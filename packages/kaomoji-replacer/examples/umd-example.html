<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaomoji Replacer - UMD Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .demo {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        .highlight {
            background: #ffffcc;
            padding: 2px 5px;
            border-radius: 3px;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #2196f3;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>Kaomoji Replacer - UMD 使用示例</h1>

    <div class="info">
        <strong>✨ 特点：</strong>
        <ul>
            <li><span class="highlight">只需引入一个 UMD 文件</span></li>
            <li>使用 <code>initKaomojiStorage</code> 从 <span class="highlight">CDN 自动加载模板</span></li>
            <li><span class="highlight">首次从 CDN 加载，之后从 IndexedDB 缓存读取</span>（离线可用）</li>
            <li>支持 jsDelivr 和 unpkg 两种 CDN</li>
        </ul>
    </div>

    <div class="demo">
        <h2>引入方式</h2>
        <p><strong>方式 1: 使用 CDN (jsDelivr)</strong></p>
        <pre><code>&lt;script src="https://cdn.jsdelivr.net/npm/kaomoji-replacer@latest/dist/kaomoji-replacer.umd.min.js"&gt;&lt;/script&gt;</code></pre>

        <p><strong>方式 2: 使用 CDN (unpkg)</strong></p>
        <pre><code>&lt;script src="https://unpkg.com/kaomoji-replacer@latest/dist/kaomoji-replacer.umd.min.js"&gt;&lt;/script&gt;</code></pre>

        <p><strong>方式 3: 本地引用</strong></p>
        <pre><code>&lt;script src="../dist/kaomoji-replacer.umd.min.js"&gt;&lt;/script&gt;</code></pre>
    </div>

    <div class="demo">
        <h2>使用方法</h2>
        <pre><code>// 从 CDN 加载默认模板（首次从 CDN 加载，之后从 IndexedDB 读取）
const kaomojis = await KaomojiReplacer.initKaomojiStorage({
    defaultURL: 'https://cdn.jsdelivr.net/npm/kaomoji-replacer/data/kaomojis.template.json'
});

// 创建替换器
const replacer = KaomojiReplacer.createReplacer({ kaomojis });

// 使用
const result = replacer.replaceText('今天很[kaomoji:开心]');
console.log(result.text);  // 输出: 今天很ヽ(´▽`)/ (或其他匹配的颜文字)</code></pre>
    </div>

    <h2>在线测试</h2>
    <div class="demo">
        <div>
            <button onclick="initWithCDN('jsdelivr')">使用 jsDelivr CDN 初始化</button>
            <button onclick="initWithCDN('unpkg')">使用 unpkg CDN 初始化</button>
            <button onclick="showStorageStats()">查看缓存状态</button>
            <button onclick="clearCache()">清空缓存</button>
        </div>
        <div class="result" id="status">点击按钮初始化...</div>
    </div>

    <div class="demo">
        <textarea id="input" placeholder="输入文本，如：这个真的很[kaomoji:开心]呢！">今天真是太[kaomoji:无语,黑脸]了，不过还是很[kaomoji:开心,高兴]的。虽然想[kaomoji:掀桌,愤怒]，但还是决定[kaomoji:躺平,摆烂]算了。</textarea>
        <button onclick="processText()">替换颜文字</button>
        <div class="result" id="output">请先初始化...</div>
    </div>

    <!-- 本地引用示例，实际使用时替换为 CDN -->
    <script src="../dist/kaomoji-replacer.umd.min.js"></script>

    <script>
        let replacer = null;

        // 从 CDN 初始化
        async function initWithCDN(cdn = 'jsdelivr') {
            try {
                const cdnURL = cdn === 'unpkg'
                    ? 'https://unpkg.com/kaomoji-replacer/data/kaomojis.template.json'
                    : 'https://cdn.jsdelivr.net/npm/kaomoji-replacer/data/kaomojis.template.json';

                document.getElementById('status').innerHTML = `正在从 ${cdn} CDN 加载...`;

                // 使用 initKaomojiStorage 自动管理缓存
                const kaomojis = await KaomojiReplacer.initKaomojiStorage({
                    defaultURL: cdnURL
                });

                // 创建替换器
                replacer = KaomojiReplacer.createReplacer({ kaomojis });

                document.getElementById('status').innerHTML = `
                    ✓ 初始化成功！<br>
                    CDN: ${cdn}<br>
                    已加载 ${kaomojis.length} 个颜文字<br>
                    <small>（数据已缓存到 IndexedDB，下次访问将直接从缓存读取）</small>
                `;

                console.log('Kaomoji Replacer initialized with', kaomojis.length, 'kaomojis');
            } catch (error) {
                document.getElementById('status').innerHTML = `❌ 初始化失败: ${error.message}`;
                console.error('Initialization error:', error);
            }
        }

        // 替换文本
        function processText() {
            if (!replacer) {
                document.getElementById('output').innerHTML = '❌ 请先初始化！';
                return;
            }

            const input = document.getElementById('input').value;
            const result = replacer.replaceText(input);

            document.getElementById('output').innerHTML = `
                <strong>原文:</strong><br>
                ${input}<br><br>
                <strong>替换后:</strong><br>
                ${result.text}<br><br>
                <strong>统计:</strong> 成功 ${result.successCount} | 失败 ${result.failureCount}
            `;
        }

        // 查看缓存状态
        async function showStorageStats() {
            const stats = await KaomojiReplacer.getStorageStats();
            document.getElementById('status').innerHTML = `
                <strong>IndexedDB 缓存状态：</strong><br>
                ${stats.hasData ? '✓ 有缓存' : '✗ 无缓存'}<br>
                颜文字数量: ${stats.count}<br>
                缓存大小: ${stats.sizeKB} KB
            `;
        }

        // 清空缓存
        async function clearCache() {
            const success = await KaomojiReplacer.clearKaomojis();
            if (success) {
                document.getElementById('status').innerHTML = '✓ 缓存已清空！下次初始化将重新从 CDN 加载。';
                replacer = null;
            } else {
                document.getElementById('status').innerHTML = '❌ 清空失败';
            }
        }

        // 页面加载时输出版本信息
        console.log('Kaomoji Replacer Version:', window.KaomojiReplacer.VERSION);
        console.log('Available APIs:', Object.keys(window.KaomojiReplacer));
    </script>
</body>
</html>
