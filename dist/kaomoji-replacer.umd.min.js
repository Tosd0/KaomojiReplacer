/**
 * Kaomoji Replacer v1.2.1
 * 基于 BM25 算法的颜文字替换插件
 * (c) 2025 Tosd0
 * @license MIT
 */
!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports):"function"==typeof define&&define.amd?define(["exports"],o):o((e="undefined"!=typeof globalThis?globalThis:e||self).KaomojiReplacer={})}(this,function(e){"use strict";class o{constructor(e){this.searchEngine=e,this.config={markerPattern:/\[kaomoji:([^\]]+)\]/gi,keywordSeparator:",",replaceStrategy:"best"}}setConfig(e){Object.assign(this.config,e)}loadKaomojis(e){this.searchEngine.buildIndex(e)}replaceText(e,o={}){const{strategy:t=this.config.replaceStrategy,threshold:r=0,keepOriginalOnNotFound:a=!0,markNotFound:n=!1}=o;let i=e;const s=[];let c=0;return i=i.replace(this.config.markerPattern,(e,o,i)=>{const l=o.split(this.config.keywordSeparator).map(e=>e.trim()).filter(e=>e.length>0);if(0===l.length)return a?e:"";const h=l.join(" "),d=this.searchEngine.search(h,5,r);let m="",u=null;if(d.length>0){switch(t){case"first":case"best":default:u=d[0],m=d[0].kaomoji;break;case"all":m=d.map(e=>e.kaomoji).join(" "),u=d}return s.push({index:c++,original:e,keywords:l,kaomoji:m,offset:i,matches:d,selected:u}),m}return s.push({index:c++,original:e,keywords:l,kaomoji:null,offset:i,matches:[],selected:null,notFound:!0}),n?`[?${o}]`:a?e:""}),{text:i,replacements:s,originalText:e,hasReplacements:s.length>0,successCount:s.filter(e=>!e.notFound).length,failureCount:s.filter(e=>e.notFound).length}}replaceMultiple(e,o={}){return e.map(e=>this.replaceText(e,o))}preview(e){const o=[];let t;const r=RegExp(this.config.markerPattern);for(;null!==(t=r.exec(e));){const e=t[1].split(this.config.keywordSeparator).map(e=>e.trim()).filter(e=>e.length>0),r=e.join(" "),a=this.searchEngine.search(r,5,0);o.push({marker:t[0],keywords:e,offset:t.index,matches:a,bestMatch:a.length>0?a[0]:null})}return o}query(e,o=5){return this.searchEngine.search(e,o,0)}exactQuery(e){return this.searchEngine.exactMatch(e)}getStats(){return{totalKaomojis:this.searchEngine.documents.length,avgDocLength:this.searchEngine.avgDocLength,config:{...this.config}}}}class t{constructor(e={}){this.k1=e.k1||1.5,this.b=e.b||.75,this.charWeight=e.charWeight||.6,this.documents=[],this.avgDocLength=0,this.avgCharDocLength=0,this.idf=new Map,this.charIdf=new Map}_parseKeywordWeight(e){const o=e.match(/^([0-9]+\.?[0-9]*)(.+)$/);if(o){const e=parseFloat(o[1]),t=o[2];if(!isNaN(e)&&e>0)return{keyword:t,weight:e}}return{keyword:e,weight:1}}buildIndex(e){this.documents=e.map(e=>{const o=new Map,t=e.keywords.map(e=>{const{keyword:t,weight:r}=this._parseKeywordWeight(e);return o.set(t,r),t}),r=t.flatMap(e=>e.split("")),a=new Map;for(const e of t)a.set(e,(a.get(e)||0)+1);const n=new Map;for(const e of r)n.set(e,(n.get(e)||0)+1);const i=t.filter(e=>e.length>=2),s=new Map;return i.forEach(e=>{[...new Set(e.split(""))].forEach(o=>{s.has(o)||s.set(o,[]),s.get(o).push(e)})}),{kaomoji:e.kaomoji,keywords:t,keywordWeights:o,chars:r,keywordFreq:a,charFreq:n,multiCharKeywords:i,charToMultiCharKeywords:s,weight:e.weight||1,category:e.category||""}});const o=this.documents.reduce((e,o)=>e+o.keywords.length,0);this.avgDocLength=o/this.documents.length;const t=this.documents.reduce((e,o)=>e+o.chars.length,0);this.avgCharDocLength=t/this.documents.length,this._calculateIDF()}_calculateIDF(){const e=new Map,o=new Map,t=this.documents.length;this.documents.forEach(t=>{new Set(t.keywords).forEach(o=>{e.set(o,(e.get(o)||0)+1)});new Set(t.chars).forEach(e=>{o.set(e,(o.get(e)||0)+1)})}),e.forEach((e,o)=>{this.idf.set(o,Math.log((t-e+.5)/(e+.5)+1))}),o.forEach((e,o)=>{this.charIdf.set(o,Math.log((t-e+.5)/(e+.5)+1))})}_calculateKeywordWeight(e,o){if(0===e.size)return 1;let t=-1/0,r=1/0,a=!1,n=!1;for(const i of e){const e=o.get(i)||1;e>1?(t=Math.max(t,e),a=!0):1>e&&(r=Math.min(r,e),n=!0)}return a&&n?t*r:a?t:n?r:1}_calculateBM25(e,o,t,r){let a=0;const n=r.keywords.length,i=new Set,s=new Set;e.forEach(e=>{const o=r.keywordFreq.get(e)||0;if(0===o)return;s.add(e);const t=this.idf.get(e)||0;a+=t*(o*(this.k1+1)/(o+this.k1*(1-this.b+this.b*(n/this.avgDocLength))))}),t.forEach(e=>{const o=r.charToMultiCharKeywords.get(e)||[];if(o.length>0){o.forEach(e=>s.add(e));const t=o.reduce((e,o)=>e+(r.keywordFreq.get(o)||0),0);if(t>0){const o=this.idf.get(e)||this.charIdf.get(e)||0;a+=o*(t*(this.k1+1)/(t+this.k1*(1-this.b+this.b*(n/this.avgDocLength)))),i.add(e)}}});let c=0;const l=r.chars.length;o.forEach(e=>{if(i.has(e))return;const o=r.charFreq.get(e)||0;if(0===o)return;const t=this.charIdf.get(e)||0;c+=t*(o*(this.k1+1)/(o+this.k1*(1-this.b+this.b*(l/this.avgCharDocLength))))});return(a+c*this.charWeight)*this._calculateKeywordWeight(s,r.keywordWeights)*r.weight}search(e,o=5,t=0){if(!e||0===this.documents.length)return[];const r=this._tokenize(e);if(0===r.length)return[];const a=new Set(r),n=[...new Set(r.flatMap(e=>e.split("")))],i=r.filter(e=>1===e.length);return this.documents.map(e=>({kaomoji:e.kaomoji,score:this._calculateBM25(r,n,i,e),matchedKeywords:e.keywords.filter(e=>a.has(e)),category:e.category})).filter(e=>e.score>t).map(e=>({item:e,random:Math.random()})).sort((e,o)=>o.item.score-e.item.score||e.random-o.random).map(({item:e})=>e).slice(0,o)}_tokenize(e){const o=e.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g," ").split(/\s+/).filter(e=>e.length>0);return(e.match(/[\u4e00-\u9fa5]+/g)||[]).forEach(e=>{for(let t=2;Math.min(4,e.length)>=t;t++)for(let r=0;e.length-t>=r;r++)o.push(e.slice(r,r+t));for(let t of e)o.push(t)}),[...new Set(o)]}exactMatch(e){const o=[];return this.documents.forEach(t=>{const r=t.keywords.filter(o=>e.includes(o));if(r.length>0){const e=new Set(r),a=this._calculateKeywordWeight(e,t.keywordWeights);o.push({kaomoji:t.kaomoji,matchedKeywords:r,score:r.length*a*t.weight,category:t.category})}}),o.map(e=>({item:e,random:Math.random()})).sort((e,o)=>o.item.score-e.item.score||e.random-o.random).map(({item:e})=>e)}}class r{constructor(){this.kaomojis=[]}loadFromJSON(e){try{const o=JSON.parse(e);return this.loadFromArray(o)}catch(e){throw console.error("Failed to parse JSON:",e),Error("Invalid JSON format")}}loadFromArray(e){if(!Array.isArray(e))throw Error("Data must be an array");return this.kaomojis=[],e.forEach((e,o)=>{this._validateItem(e,o)&&this.kaomojis.push(this._normalizeItem(e))}),console.log(`Loaded ${this.kaomojis.length} kaomojis`),this}_validateItem(e,o){return e.kaomoji&&"string"==typeof e.kaomoji?!(!e.keywords||!Array.isArray(e.keywords)||0===e.keywords.length)||(console.warn(`Item ${o}: Missing or invalid 'keywords' field, skipping`),!1):(console.warn(`Item ${o}: Missing or invalid 'kaomoji' field, skipping`),!1)}_normalizeItem(e){return{kaomoji:e.kaomoji,keywords:e.keywords.map(e=>(e+"").trim()).filter(e=>e.length>0),weight:"number"==typeof e.weight?e.weight:1,category:e.category||""}}_deepCopy(e){return{kaomoji:e.kaomoji,keywords:[...e.keywords],weight:e.weight,category:e.category}}getAllKaomojis(){return this.kaomojis.map(e=>this._deepCopy(e))}getKaomojiByText(e){const o=this.kaomojis.find(o=>o.kaomoji===e);return o?this._deepCopy(o):null}getAllKeywords(){const e=new Set;return this.kaomojis.forEach(o=>{o.keywords.forEach(o=>e.add(o))}),Array.from(e).sort()}getKeywordsByKaomoji(e){const o=this.kaomojis.find(o=>o.kaomoji===e);return o?[...o.keywords]:[]}filterByCategory(e){const o=Array.isArray(e)?e:[e];return this.kaomojis.filter(e=>o.includes(e.category)).map(e=>this._deepCopy(e))}getAllCategories(){const e=new Set;return this.kaomojis.forEach(o=>{o.category&&e.add(o.category)}),Array.from(e).sort()}findByKeyword(e){const o=(Array.isArray(e)?e:[e]).map(e=>((e||"")+"").trim()).filter(e=>e.length>0);return 0===o.length?[]:this.kaomojis.filter(e=>o.every(o=>e.keywords.includes(o))).map(e=>this._deepCopy(e))}getStats(){return{totalKaomojis:this.kaomojis.length,totalKeywords:this.getAllKeywords().length,totalCategories:this.getAllCategories().length,averageKeywordsPerKaomoji:this.kaomojis.length>0?this.kaomojis.reduce((e,o)=>e+o.keywords.length,0)/this.kaomojis.length:0}}addKeyword(e,o){const t=this.kaomojis.find(o=>o.kaomoji===e);if(!t)return console.warn(`Kaomoji "${e}" not found`),!1;const r=(o+"").trim();return r?t.keywords.includes(r)?(console.warn(`Keyword "${r}" already exists`),!1):(t.keywords.push(r),!0):(console.warn("Keyword cannot be empty"),!1)}removeKeyword(e,o){const t=this.kaomojis.find(o=>o.kaomoji===e);if(!t)return console.warn(`Kaomoji "${e}" not found`),!1;const r=t.keywords.indexOf(o);return-1===r?(console.warn(`Keyword "${o}" not found`),!1):t.keywords.length>1?(t.keywords.splice(r,1),!0):(console.warn("Cannot remove the last keyword"),!1)}updateKeywords(e,o){const t=this.kaomojis.find(o=>o.kaomoji===e);if(!t)return console.warn(`Kaomoji "${e}" not found`),!1;if(!Array.isArray(o)||0===o.length)return console.warn("Keywords must be a non-empty array"),!1;const r=o.map(e=>(e+"").trim()).filter(e=>e.length>0);return 0===r.length?(console.warn("No valid keywords provided"),!1):(t.keywords=r,!0)}setCategory(e,o){const t=this.kaomojis.find(o=>o.kaomoji===e);return t?(t.category=o||"",!0):(console.warn(`Kaomoji "${e}" not found`),!1)}setWeight(e,o){const t=this.kaomojis.find(o=>o.kaomoji===e);return t?"number"==typeof o&&o>0?(t.weight=o,!0):(console.warn("Weight must be a positive number"),!1):(console.warn(`Kaomoji "${e}" not found`),!1)}addKaomoji(e){return!!this._validateItem(e,"new")&&(this.kaomojis.find(o=>o.kaomoji===e.kaomoji)?(console.warn(`Kaomoji "${e.kaomoji}" already exists`),!1):(this.kaomojis.push(this._normalizeItem(e)),!0))}removeKaomoji(e){const o=this.kaomojis.findIndex(o=>o.kaomoji===e);return-1===o?(console.warn(`Kaomoji "${e}" not found`),!1):(this.kaomojis.splice(o,1),!0)}updateKaomoji(e,o){const t=this.kaomojis.findIndex(o=>o.kaomoji===e);return-1===t?(console.warn(`Kaomoji "${e}" not found`),!1):!!this._validateItem(o,"update")&&(o.kaomoji!==e&&this.kaomojis.find(e=>e.kaomoji===o.kaomoji)?(console.warn(`Kaomoji "${o.kaomoji}" already exists`),!1):(this.kaomojis[t]=this._normalizeItem(o),!0))}exportToJSON(e=!0){return JSON.stringify(this.kaomojis,null,e?2:0)}exportToArray(){return this.kaomojis.map(e=>({...e,keywords:[...e.keywords]}))}batchSetCategory(e,o){let t=0;return e.forEach(e=>{this.setCategory(e,o)&&t++}),t}batchRemove(e){let o=0;return e.forEach(e=>{this.removeKaomoji(e)&&o++}),o}clear(){this.kaomojis=[]}}const a="kaomojis",n="kaomoji_data";let i=!1;function s(e,...o){i&&console.log("[KaomojiReplacer] "+e,...o)}function c(e,...o){i&&console.warn("[KaomojiReplacer] "+e,...o)}function l(e,...o){i?console.error("[KaomojiReplacer] "+e,...o):console.error("[KaomojiReplacer] "+e)}function h(){return new Promise((e,o)=>{if("undefined"==typeof indexedDB)return void o(Error("IndexedDB is not supported in this environment"));const t=indexedDB.open("KaomojiReplacerDB",1);t.onerror=()=>{o(Error("Failed to open IndexedDB"))},t.onsuccess=()=>{e(t.result)},t.onupgradeneeded=e=>{const o=e.target.result;o.objectStoreNames.contains(a)||o.createObjectStore(a)}})}async function d(){try{const e=await h();return new Promise((o,t)=>{const r=e.transaction([a],"readonly"),i=r.objectStore(a).get(n);r.oncomplete=()=>{e.close()},r.onerror=()=>{e.close(),t(Error("Transaction failed"))},i.onsuccess=()=>{o(i.result||null)},i.onerror=()=>{t(Error("Failed to read from IndexedDB"))}})}catch(e){return l("Error reading from IndexedDB:",e),null}}async function m(e){if(!Array.isArray(e))return l("Data must be an array"),!1;try{const o=await h();return new Promise((t,r)=>{const i=o.transaction([a],"readwrite"),c=i.objectStore(a).put(e,n);i.oncomplete=()=>{o.close(),s(`Saved ${e.length} kaomojis to IndexedDB`),t(!0)},i.onerror=()=>{o.close(),r(Error("Transaction failed"))},c.onerror=()=>{r(Error("Failed to save to IndexedDB"))}})}catch(e){return l("Error saving to IndexedDB:",e),!1}}var u=Object.freeze({__proto__:null,clearKaomojis:async function(){try{const e=await h();return new Promise((o,t)=>{const r=e.transaction([a],"readwrite"),i=r.objectStore(a).delete(n);r.oncomplete=()=>{e.close(),s("Cleared kaomojis from IndexedDB"),o(!0)},r.onerror=()=>{e.close(),t(Error("Transaction failed"))},i.onerror=()=>{t(Error("Failed to clear IndexedDB"))}})}catch(e){return l("Error clearing IndexedDB:",e),!1}},getKaomojis:d,getStorageStats:async function(){try{const e=await d();return{hasData:null!==e,count:e?e.length:0,sizeKB:e?(JSON.stringify(e).length/1024).toFixed(2):"0.00"}}catch(e){return{hasData:!1,count:0,sizeKB:0,error:e.message}}},initKaomojiStorage:async function(e={}){const{defaultURL:o=null,forceReload:t=!1}=e;try{if(!t){const e=await d();if(e&&e.length>0)return s(`Loaded ${e.length} kaomojis from IndexedDB cache`),e}if(o){s(`Loading default kaomojis from ${o}...`);const e=await async function(e){try{const o=await fetch(e);if(!o.ok)return c(`Failed to fetch from ${e}: ${o.status}`),null;const t=await o.json();return Array.isArray(t)?t:(c("Remote data is not an array"),null)}catch(e){return c("Failed to load from remote:",e),null}}(o);if(e&&e.length>0)return await m(e),s(`Initialized with ${e.length} kaomojis from remote`),e;c("Failed to load from remote, returning empty array")}return[]}catch(e){return l("Error initializing kaomoji storage:",e),[]}},saveKaomojis:m,setDebugMode:function(e){i=e}});function g(e={}){const{kaomojis:a=[],jsonData:n=null,searchConfig:i={},replaceConfig:s={}}=e,c=new t(i),l=new o(c);if(s&&l.setConfig(s),n){const e=new r;e.loadFromJSON(n),l.loadKaomojis(e.getAllKaomojis())}else a.length>0&&l.loadKaomojis(a);return l}const{initKaomojiStorage:f,getKaomojis:y,saveKaomojis:w,clearKaomojis:k,getStorageStats:p,setDebugMode:j}=u;e.DEFAULT_CONFIG={search:{k1:1.5,b:.75},replace:{markerPattern:/\[kaomoji:([^\]]+)\]/gi,keywordSeparator:",",replaceStrategy:"best"}},e.IndexedDBStorage=u,e.KaomojiDataManager=r,e.KaomojiReplacer=o,e.REPLACE_STRATEGIES={FIRST:"first",BEST:"best",ALL:"all"},e.SearchEngine=t,e.VERSION="1.2.1",e.batchReplace=function(e,o,t={}){return g({kaomojis:Array.isArray(o)?o:[],jsonData:"string"==typeof o?o:null,searchConfig:t.searchConfig,replaceConfig:t.replaceConfig}).replaceMultiple(e,t)},e.clearKaomojis=k,e.createManager=function(e=null){const o=new r;return e&&("string"==typeof e?o.loadFromJSON(e):Array.isArray(e)&&o.loadFromArray(e)),o},e.createReplacer=g,e.createSearchEngine=function(e={}){return new t(e)},e.getKaomojis=y,e.getStorageStats=p,e.initKaomojiStorage=f,e.loadFromFile=async function(e){if("undefined"==typeof process)throw Error("loadFromFile is only available in Node.js environment");const{promises:o}=await import("fs"),t=await o.readFile(e,"utf8"),a=new r;return a.loadFromJSON(t),a.getAllKaomojis()},e.loadFromURL=async function(e){const o=await fetch(e);if(!o.ok)throw Error(`Failed to load from URL: ${o.status} ${o.statusText}`);const t=await o.text(),a=new r;return a.loadFromJSON(t),a.getAllKaomojis()},e.quickQuery=function(e,o,t=5){return g({kaomojis:Array.isArray(o)?o:[],jsonData:"string"==typeof o?o:null}).query(e,t)},e.quickReplace=function(e,o,t={}){return g({kaomojis:Array.isArray(o)?o:[],jsonData:"string"==typeof o?o:null,searchConfig:t.searchConfig,replaceConfig:t.replaceConfig}).replaceText(e,t)},e.saveKaomojis=w,e.setDebugMode=j,e.validateData=function(e){const o=[];return Array.isArray(e)?(e.forEach((e,t)=>{"object"==typeof e&&null!==e?(e.kaomoji&&"string"==typeof e.kaomoji||o.push(`Item ${t}: Missing or invalid 'kaomoji' field`),e.keywords&&Array.isArray(e.keywords)&&0!==e.keywords.length||o.push(`Item ${t}: Missing or invalid 'keywords' field`),void 0===e.weight||"number"==typeof e.weight&&e.weight>0||o.push(`Item ${t}: Invalid 'weight' field (must be positive number)`)):o.push(`Item ${t}: Must be an object.`)}),{valid:0===o.length,errors:o}):{valid:!1,errors:["Data must be an array"]}}});
//# sourceMappingURL=kaomoji-replacer.umd.min.js.map
