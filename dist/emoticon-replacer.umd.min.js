/**
 * Emoticon Replacer v1.0.1
 * 基于 BM25 算法的颜文字替换插件
 * (c) 2025 Tosd0
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs")):"function"==typeof define&&define.amd?define(["exports","fs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).EmoticonReplacer={},e.fs)}(this,function(e,t){"use strict";function o(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function n(e){throw Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var r={exports:{}};!function(e){class t{constructor(e){this.searchEngine=e,this.config={markerPattern:/\[emoticon:([^\]]+)\]/gi,keywordSeparator:",",replaceStrategy:"best"}}setConfig(e){Object.assign(this.config,e)}loadEmoticons(e){this.searchEngine.buildIndex(e)}replaceText(e,t={}){const{strategy:o=this.config.replaceStrategy,threshold:n=0,keepOriginalOnNotFound:r=!0,markNotFound:i=!1}=t;let s=e;const a=[];let c=0;return s=s.replace(this.config.markerPattern,(e,t,s)=>{const l=t.split(this.config.keywordSeparator).map(e=>e.trim()).filter(e=>e.length>0);if(0===l.length)return r?e:"";const d=l.join(" "),m=this.searchEngine.search(d,5,n);let u="",h=null;if(m.length>0){switch(o){case"first":case"best":default:h=m[0],u=m[0].emoticon;break;case"all":u=m.map(e=>e.emoticon).join(" "),h=m}return a.push({index:c++,original:e,keywords:l,emoticon:u,offset:s,matches:m,selected:h}),u}return a.push({index:c++,original:e,keywords:l,emoticon:null,offset:s,matches:[],selected:null,notFound:!0}),i?`[?${t}]`:r?e:""}),{text:s,replacements:a,originalText:e,hasReplacements:a.length>0,successCount:a.filter(e=>!e.notFound).length,failureCount:a.filter(e=>e.notFound).length}}replaceMultiple(e,t={}){return e.map(e=>this.replaceText(e,t))}preview(e){const t=[];let o;const n=RegExp(this.config.markerPattern);for(;null!==(o=n.exec(e));){const e=o[1].split(this.config.keywordSeparator).map(e=>e.trim()).filter(e=>e.length>0),n=e.join(" "),r=this.searchEngine.search(n,5,0);t.push({marker:o[0],keywords:e,offset:o.index,matches:r,bestMatch:r.length>0?r[0]:null})}return t}query(e,t=5){return this.searchEngine.search(e,t,0)}exactQuery(e){return this.searchEngine.exactMatch(e)}getStats(){return{totalEmoticons:this.searchEngine.documents.length,avgDocLength:this.searchEngine.avgDocLength,config:{...this.config}}}}e.exports&&(e.exports=t),"undefined"!=typeof window&&(window.EmoticonReplacer=t)}(r);var i=r.exports,s={exports:{}};!function(e){class t{constructor(e={}){this.k1=e.k1||1.5,this.b=e.b||.75,this.documents=[],this.avgDocLength=0,this.idf=new Map}buildIndex(e){this.documents=e.map(e=>({emoticon:e.emoticon,keywords:[...e.keywords],weight:e.weight||1,category:e.category||""}));const t=this.documents.reduce((e,t)=>e+t.keywords.length,0);this.avgDocLength=t/this.documents.length,this._calculateIDF()}_calculateIDF(){const e=new Map,t=this.documents.length;this.documents.forEach(t=>{new Set(t.keywords).forEach(t=>{e.set(t,(e.get(t)||0)+1)})}),e.forEach((e,o)=>{this.idf.set(o,Math.log((t-e+.5)/(e+.5)+1))})}_calculateBM25(e,t){let o=0;const n=t.keywords.length;return e.forEach(e=>{const r=t.keywords.filter(t=>t===e).length;if(0===r)return;const i=this.idf.get(e)||0;o+=i*(r*(this.k1+1)/(r+this.k1*(1-this.b+this.b*(n/this.avgDocLength))))}),o*t.weight}search(e,t=5,o=0){if(!e||0===this.documents.length)return[];const n=this._tokenize(e);if(0===n.length)return[];const r=new Set(n);return this.documents.map(e=>({emoticon:e.emoticon,score:this._calculateBM25(n,e),matchedKeywords:e.keywords.filter(e=>r.has(e)),category:e.category})).filter(e=>e.score>o&&e.matchedKeywords.length>0).sort((e,t)=>t.score-e.score).slice(0,t)}_tokenize(e){const t=e.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g," ").split(/\s+/).filter(e=>e.length>0);return(e.match(/[\u4e00-\u9fa5]+/g)||[]).forEach(e=>{for(let o=2;Math.min(4,e.length)>=o;o++)for(let n=0;e.length-o>=n;n++)t.push(e.slice(n,n+o));for(let o of e)t.push(o)}),[...new Set(t)]}exactMatch(e){const t=[];return this.documents.forEach(o=>{const n=o.keywords.filter(t=>e.includes(t));n.length>0&&t.push({emoticon:o.emoticon,matchedKeywords:n,score:n.length*o.weight,category:o.category})}),t.sort((e,t)=>t.score-e.score)}}e.exports&&(e.exports=t),"undefined"!=typeof window&&(window.SearchEngine=t)}(s);var a=s.exports,c={exports:{}};!function(e){class t{constructor(){this.emoticons=[]}loadFromJSON(e){try{const t=JSON.parse(e);return this.loadFromArray(t)}catch(e){throw console.error("Failed to parse JSON:",e),Error("Invalid JSON format")}}loadFromArray(e){if(!Array.isArray(e))throw Error("Data must be an array");return this.emoticons=[],e.forEach((e,t)=>{this._validateItem(e,t)&&this.emoticons.push(this._normalizeItem(e))}),console.log(`Loaded ${this.emoticons.length} emoticons`),this}_validateItem(e,t){return e.emoticon&&"string"==typeof e.emoticon?!(!e.keywords||!Array.isArray(e.keywords)||0===e.keywords.length)||(console.warn(`Item ${t}: Missing or invalid 'keywords' field, skipping`),!1):(console.warn(`Item ${t}: Missing or invalid 'emoticon' field, skipping`),!1)}_normalizeItem(e){return{emoticon:e.emoticon,keywords:e.keywords.map(e=>(e+"").trim()).filter(e=>e.length>0),weight:"number"==typeof e.weight?e.weight:1,category:e.category||""}}_deepCopy(e){return{emoticon:e.emoticon,keywords:[...e.keywords],weight:e.weight,category:e.category}}getAllEmoticons(){return this.emoticons.map(e=>this._deepCopy(e))}getEmoticonByText(e){const t=this.emoticons.find(t=>t.emoticon===e);return t?this._deepCopy(t):null}getAllKeywords(){const e=new Set;return this.emoticons.forEach(t=>{t.keywords.forEach(t=>e.add(t))}),Array.from(e).sort()}getKeywordsByEmoticon(e){const t=this.emoticons.find(t=>t.emoticon===e);return t?[...t.keywords]:[]}filterByCategory(e){const t=Array.isArray(e)?e:[e];return this.emoticons.filter(e=>t.includes(e.category)).map(e=>this._deepCopy(e))}getAllCategories(){const e=new Set;return this.emoticons.forEach(t=>{t.category&&e.add(t.category)}),Array.from(e).sort()}findByKeyword(e){return this.emoticons.filter(t=>t.keywords.includes(e)).map(e=>this._deepCopy(e))}getStats(){return{totalEmoticons:this.emoticons.length,totalKeywords:this.getAllKeywords().length,totalCategories:this.getAllCategories().length,averageKeywordsPerEmoticon:this.emoticons.length>0?this.emoticons.reduce((e,t)=>e+t.keywords.length,0)/this.emoticons.length:0}}addKeyword(e,t){const o=this.emoticons.find(t=>t.emoticon===e);if(!o)return console.warn(`Emoticon "${e}" not found`),!1;const n=(t+"").trim();return n?o.keywords.includes(n)?(console.warn(`Keyword "${n}" already exists`),!1):(o.keywords.push(n),!0):(console.warn("Keyword cannot be empty"),!1)}removeKeyword(e,t){const o=this.emoticons.find(t=>t.emoticon===e);if(!o)return console.warn(`Emoticon "${e}" not found`),!1;const n=o.keywords.indexOf(t);return-1===n?(console.warn(`Keyword "${t}" not found`),!1):o.keywords.length>1?(o.keywords.splice(n,1),!0):(console.warn("Cannot remove the last keyword"),!1)}updateKeywords(e,t){const o=this.emoticons.find(t=>t.emoticon===e);if(!o)return console.warn(`Emoticon "${e}" not found`),!1;if(!Array.isArray(t)||0===t.length)return console.warn("Keywords must be a non-empty array"),!1;const n=t.map(e=>(e+"").trim()).filter(e=>e.length>0);return 0===n.length?(console.warn("No valid keywords provided"),!1):(o.keywords=n,!0)}setCategory(e,t){const o=this.emoticons.find(t=>t.emoticon===e);return o?(o.category=t||"",!0):(console.warn(`Emoticon "${e}" not found`),!1)}setWeight(e,t){const o=this.emoticons.find(t=>t.emoticon===e);return o?"number"==typeof t&&t>0?(o.weight=t,!0):(console.warn("Weight must be a positive number"),!1):(console.warn(`Emoticon "${e}" not found`),!1)}addEmoticon(e){return!!this._validateItem(e,"new")&&(this.emoticons.find(t=>t.emoticon===e.emoticon)?(console.warn(`Emoticon "${e.emoticon}" already exists`),!1):(this.emoticons.push(this._normalizeItem(e)),!0))}removeEmoticon(e){const t=this.emoticons.findIndex(t=>t.emoticon===e);return-1===t?(console.warn(`Emoticon "${e}" not found`),!1):(this.emoticons.splice(t,1),!0)}updateEmoticon(e,t){const o=this.emoticons.findIndex(t=>t.emoticon===e);return-1===o?(console.warn(`Emoticon "${e}" not found`),!1):!!this._validateItem(t,"update")&&(t.emoticon!==e&&this.emoticons.find(e=>e.emoticon===t.emoticon)?(console.warn(`Emoticon "${t.emoticon}" already exists`),!1):(this.emoticons[o]=this._normalizeItem(t),!0))}exportToJSON(e=!0){return JSON.stringify(this.emoticons,null,e?2:0)}exportToArray(){return this.emoticons.map(e=>({...e,keywords:[...e.keywords]}))}batchSetCategory(e,t){let o=0;return e.forEach(e=>{this.setCategory(e,t)&&o++}),o}batchRemove(e){let t=0;return e.forEach(e=>{this.removeEmoticon(e)&&t++}),t}clear(){this.emoticons=[]}}e.exports&&(e.exports=t),"undefined"!=typeof window&&(window.EmoticonDataManager=t)}(c);var l=c.exports,d={exports:{}};!function(e){const t="emoticons",o="emoticon_data";let n=!1;function r(e,...t){n&&console.log("[EmoticonReplacer] "+e,...t)}function i(e,...t){n&&console.warn("[EmoticonReplacer] "+e,...t)}function s(e,...t){n?console.error("[EmoticonReplacer] "+e,...t):console.error("[EmoticonReplacer] "+e)}function a(){return new Promise((e,o)=>{if("undefined"==typeof indexedDB)return void o(Error("IndexedDB is not supported in this environment"));const n=indexedDB.open("EmoticonReplacerDB",1);n.onerror=()=>{o(Error("Failed to open IndexedDB"))},n.onsuccess=()=>{e(n.result)},n.onupgradeneeded=e=>{const o=e.target.result;o.objectStoreNames.contains(t)||o.createObjectStore(t)}})}async function c(){try{const e=await a();return new Promise((n,r)=>{const i=e.transaction([t],"readonly"),s=i.objectStore(t).get(o);i.oncomplete=()=>{e.close()},i.onerror=()=>{e.close(),r(Error("Transaction failed"))},s.onsuccess=()=>{n(s.result||null)},s.onerror=()=>{r(Error("Failed to read from IndexedDB"))}})}catch(e){return s("Error reading from IndexedDB:",e),null}}async function l(e){if(!Array.isArray(e))return s("Data must be an array"),!1;try{const n=await a();return new Promise((i,s)=>{const a=n.transaction([t],"readwrite"),c=a.objectStore(t).put(e,o);a.oncomplete=()=>{n.close(),r(`Saved ${e.length} emoticons to IndexedDB`),i(!0)},a.onerror=()=>{n.close(),s(Error("Transaction failed"))},c.onerror=()=>{s(Error("Failed to save to IndexedDB"))}})}catch(e){return s("Error saving to IndexedDB:",e),!1}}const d={initEmoticonStorage:async function(e={}){const{defaultURL:t=null,forceReload:o=!1}=e;try{if(!o){const e=await c();if(e&&e.length>0)return r(`Loaded ${e.length} emoticons from IndexedDB cache`),e}if(t){r(`Loading default emoticons from ${t}...`);const e=await async function(e){try{const t=await fetch(e);if(!t.ok)return i(`Failed to fetch from ${e}: ${t.status}`),null;const o=await t.json();return Array.isArray(o)?o:(i("Remote data is not an array"),null)}catch(e){return i("Failed to load from remote:",e),null}}(t);if(e&&e.length>0)return await l(e),r(`Initialized with ${e.length} emoticons from remote`),e;i("Failed to load from remote, returning empty array")}return[]}catch(e){return s("Error initializing emoticon storage:",e),[]}},getEmoticons:c,saveEmoticons:l,clearEmoticons:async function(){try{const e=await a();return new Promise((n,i)=>{const s=e.transaction([t],"readwrite"),a=s.objectStore(t).delete(o);s.oncomplete=()=>{e.close(),r("Cleared emoticons from IndexedDB"),n(!0)},s.onerror=()=>{e.close(),i(Error("Transaction failed"))},a.onerror=()=>{i(Error("Failed to clear IndexedDB"))}})}catch(e){return s("Error clearing IndexedDB:",e),!1}},getStorageStats:async function(){try{const e=await c();return{hasData:null!==e,count:e?e.length:0,sizeKB:e?(JSON.stringify(e).length/1024).toFixed(2):"0.00"}}catch(e){return{hasData:!1,count:0,sizeKB:0,error:e.message}}},setDebugMode:function(e){n=e}};e.exports&&(e.exports=d),"undefined"!=typeof window&&(window.IndexedDBStorage=d)}(d);var m=d.exports;const u=i,h=a,f=l;function g(e={}){const{emoticons:t=[],jsonData:o=null,searchConfig:n={},replaceConfig:r={}}=e,i=new h(n),s=new u(i);if(r&&s.setConfig(r),o){const e=new f;e.loadFromJSON(o),s.loadEmoticons(e.getAllEmoticons())}else t.length>0&&s.loadEmoticons(t);return s}var y={EmoticonReplacer:u,SearchEngine:h,EmoticonDataManager:f,createReplacer:g,createManager:function(e=null){const t=new f;return e&&("string"==typeof e?t.loadFromJSON(e):Array.isArray(e)&&t.loadFromArray(e)),t},createSearchEngine:function(e={}){return new h(e)},quickReplace:function(e,t,o={}){return g({emoticons:Array.isArray(t)?t:[],jsonData:"string"==typeof t?t:null,searchConfig:o.searchConfig,replaceConfig:o.replaceConfig}).replaceText(e,o)},quickQuery:function(e,t,o=5){return g({emoticons:Array.isArray(t)?t:[],jsonData:"string"==typeof t?t:null}).query(e,o)},loadFromFile:async function(e){if(void 0===n||"undefined"==typeof process)throw Error("loadFromFile is only available in Node.js environment");const o=t.promises,r=await o.readFile(e,"utf8"),i=new f;return i.loadFromJSON(r),i.getAllEmoticons()},loadFromURL:async function(e){const t=await fetch(e);if(!t.ok)throw Error(`Failed to load from URL: ${t.status} ${t.statusText}`);const o=await t.text(),n=new f;return n.loadFromJSON(o),n.getAllEmoticons()},validateData:function(e){const t=[];return Array.isArray(e)?(e.forEach((e,o)=>{"object"==typeof e&&null!==e?(e.emoticon&&"string"==typeof e.emoticon||t.push(`Item ${o}: Missing or invalid 'emoticon' field`),e.keywords&&Array.isArray(e.keywords)&&0!==e.keywords.length||t.push(`Item ${o}: Missing or invalid 'keywords' field`),void 0===e.weight||"number"==typeof e.weight&&e.weight>0||t.push(`Item ${o}: Invalid 'weight' field (must be positive number)`)):t.push(`Item ${o}: Must be an object.`)}),{valid:0===t.length,errors:t}):{valid:!1,errors:["Data must be an array"]}},batchReplace:function(e,t,o={}){return g({emoticons:Array.isArray(t)?t:[],jsonData:"string"==typeof t?t:null,searchConfig:o.searchConfig,replaceConfig:o.replaceConfig}).replaceMultiple(e,o)},initEmoticonStorage:m.initEmoticonStorage,getEmoticons:m.getEmoticons,saveEmoticons:m.saveEmoticons,clearEmoticons:m.clearEmoticons,getStorageStats:m.getStorageStats,setDebugMode:m.setDebugMode,VERSION:"1.0.1",DEFAULT_CONFIG:{search:{k1:1.5,b:.75},replace:{markerPattern:/\[emoticon:([^\]]+)\]/gi,keywordSeparator:",",replaceStrategy:"best"}},REPLACE_STRATEGIES:{FIRST:"first",BEST:"best",ALL:"all"}};e.default=o(y),Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=emoticon-replacer.umd.min.js.map
