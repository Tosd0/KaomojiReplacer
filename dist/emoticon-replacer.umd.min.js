/**
 * Kaomoji Replacer v1.0.4
 * 基于 BM25 算法的颜文字替换插件
 * (c) 2025 Tosd0
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).KaomojiReplacer={})}(this,function(e){"use strict";class t{constructor(e){this.searchEngine=e,this.config={markerPattern:/\[kaomoji:([^\]]+)\]/gi,keywordSeparator:",",replaceStrategy:"best"}}setConfig(e){Object.assign(this.config,e)}loadKaomojis(e){this.searchEngine.buildIndex(e)}replaceText(e,t={}){const{strategy:o=this.config.replaceStrategy,threshold:n=0,keepOriginalOnNotFound:r=!0,markNotFound:i=!1}=t;let s=e;const c=[];let a=0;return s=s.replace(this.config.markerPattern,(e,t,s)=>{const l=t.split(this.config.keywordSeparator).map(e=>e.trim()).filter(e=>e.length>0);if(0===l.length)return r?e:"";const d=l.join(" "),m=this.searchEngine.search(d,5,n);let h="",u=null;if(m.length>0){switch(o){case"first":case"best":default:u=m[0],h=m[0].kaomoji;break;case"all":h=m.map(e=>e.kaomoji).join(" "),u=m}return c.push({index:a++,original:e,keywords:l,kaomoji:h,offset:s,matches:m,selected:u}),h}return c.push({index:a++,original:e,keywords:l,kaomoji:null,offset:s,matches:[],selected:null,notFound:!0}),i?`[?${t}]`:r?e:""}),{text:s,replacements:c,originalText:e,hasReplacements:c.length>0,successCount:c.filter(e=>!e.notFound).length,failureCount:c.filter(e=>e.notFound).length}}replaceMultiple(e,t={}){return e.map(e=>this.replaceText(e,t))}preview(e){const t=[];let o;const n=RegExp(this.config.markerPattern);for(;null!==(o=n.exec(e));){const e=o[1].split(this.config.keywordSeparator).map(e=>e.trim()).filter(e=>e.length>0),n=e.join(" "),r=this.searchEngine.search(n,5,0);t.push({marker:o[0],keywords:e,offset:o.index,matches:r,bestMatch:r.length>0?r[0]:null})}return t}query(e,t=5){return this.searchEngine.search(e,t,0)}exactQuery(e){return this.searchEngine.exactMatch(e)}getStats(){return{totalKaomojis:this.searchEngine.documents.length,avgDocLength:this.searchEngine.avgDocLength,config:{...this.config}}}}class o{constructor(e={}){this.k1=e.k1||1.5,this.b=e.b||.75,this.documents=[],this.avgDocLength=0,this.idf=new Map}buildIndex(e){this.documents=e.map(e=>({kaomoji:e.kaomoji,keywords:[...e.keywords],weight:e.weight||1,category:e.category||""}));const t=this.documents.reduce((e,t)=>e+t.keywords.length,0);this.avgDocLength=t/this.documents.length,this._calculateIDF()}_calculateIDF(){const e=new Map,t=this.documents.length;this.documents.forEach(t=>{new Set(t.keywords).forEach(t=>{e.set(t,(e.get(t)||0)+1)})}),e.forEach((e,o)=>{this.idf.set(o,Math.log((t-e+.5)/(e+.5)+1))})}_calculateBM25(e,t){let o=0;const n=t.keywords.length;return e.forEach(e=>{const r=t.keywords.filter(t=>t===e).length;if(0===r)return;const i=this.idf.get(e)||0;o+=i*(r*(this.k1+1)/(r+this.k1*(1-this.b+this.b*(n/this.avgDocLength))))}),o*t.weight}search(e,t=5,o=0){if(!e||0===this.documents.length)return[];const n=this._tokenize(e);if(0===n.length)return[];const r=new Set(n);return this.documents.map(e=>({kaomoji:e.kaomoji,score:this._calculateBM25(n,e),matchedKeywords:e.keywords.filter(e=>r.has(e)),category:e.category})).filter(e=>e.score>o&&e.matchedKeywords.length>0).sort((e,t)=>t.score-e.score).slice(0,t)}_tokenize(e){const t=e.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g," ").split(/\s+/).filter(e=>e.length>0);return(e.match(/[\u4e00-\u9fa5]+/g)||[]).forEach(e=>{for(let o=2;Math.min(4,e.length)>=o;o++)for(let n=0;e.length-o>=n;n++)t.push(e.slice(n,n+o));for(let o of e)t.push(o)}),[...new Set(t)]}exactMatch(e){const t=[];return this.documents.forEach(o=>{const n=o.keywords.filter(t=>e.includes(t));n.length>0&&t.push({kaomoji:o.kaomoji,matchedKeywords:n,score:n.length*o.weight,category:o.category})}),t.sort((e,t)=>t.score-e.score)}}class n{constructor(){this.kaomojis=[]}loadFromJSON(e){try{const t=JSON.parse(e);return this.loadFromArray(t)}catch(e){throw console.error("Failed to parse JSON:",e),Error("Invalid JSON format")}}loadFromArray(e){if(!Array.isArray(e))throw Error("Data must be an array");return this.kaomojis=[],e.forEach((e,t)=>{this._validateItem(e,t)&&this.kaomojis.push(this._normalizeItem(e))}),console.log(`Loaded ${this.kaomojis.length} kaomojis`),this}_validateItem(e,t){return e.kaomoji&&"string"==typeof e.kaomoji?!(!e.keywords||!Array.isArray(e.keywords)||0===e.keywords.length)||(console.warn(`Item ${t}: Missing or invalid 'keywords' field, skipping`),!1):(console.warn(`Item ${t}: Missing or invalid 'kaomoji' field, skipping`),!1)}_normalizeItem(e){return{kaomoji:e.kaomoji,keywords:e.keywords.map(e=>(e+"").trim()).filter(e=>e.length>0),weight:"number"==typeof e.weight?e.weight:1,category:e.category||""}}_deepCopy(e){return{kaomoji:e.kaomoji,keywords:[...e.keywords],weight:e.weight,category:e.category}}getAllKaomojis(){return this.kaomojis.map(e=>this._deepCopy(e))}getKaomojiByText(e){const t=this.kaomojis.find(t=>t.kaomoji===e);return t?this._deepCopy(t):null}getAllKeywords(){const e=new Set;return this.kaomojis.forEach(t=>{t.keywords.forEach(t=>e.add(t))}),Array.from(e).sort()}getKeywordsByKaomoji(e){const t=this.kaomojis.find(t=>t.kaomoji===e);return t?[...t.keywords]:[]}filterByCategory(e){const t=Array.isArray(e)?e:[e];return this.kaomojis.filter(e=>t.includes(e.category)).map(e=>this._deepCopy(e))}getAllCategories(){const e=new Set;return this.kaomojis.forEach(t=>{t.category&&e.add(t.category)}),Array.from(e).sort()}findByKeyword(e){return this.kaomojis.filter(t=>t.keywords.includes(e)).map(e=>this._deepCopy(e))}getStats(){return{totalKaomojis:this.kaomojis.length,totalKeywords:this.getAllKeywords().length,totalCategories:this.getAllCategories().length,averageKeywordsPerKaomoji:this.kaomojis.length>0?this.kaomojis.reduce((e,t)=>e+t.keywords.length,0)/this.kaomojis.length:0}}addKeyword(e,t){const o=this.kaomojis.find(t=>t.kaomoji===e);if(!o)return console.warn(`Kaomoji "${e}" not found`),!1;const n=(t+"").trim();return n?o.keywords.includes(n)?(console.warn(`Keyword "${n}" already exists`),!1):(o.keywords.push(n),!0):(console.warn("Keyword cannot be empty"),!1)}removeKeyword(e,t){const o=this.kaomojis.find(t=>t.kaomoji===e);if(!o)return console.warn(`Kaomoji "${e}" not found`),!1;const n=o.keywords.indexOf(t);return-1===n?(console.warn(`Keyword "${t}" not found`),!1):o.keywords.length>1?(o.keywords.splice(n,1),!0):(console.warn("Cannot remove the last keyword"),!1)}updateKeywords(e,t){const o=this.kaomojis.find(t=>t.kaomoji===e);if(!o)return console.warn(`Kaomoji "${e}" not found`),!1;if(!Array.isArray(t)||0===t.length)return console.warn("Keywords must be a non-empty array"),!1;const n=t.map(e=>(e+"").trim()).filter(e=>e.length>0);return 0===n.length?(console.warn("No valid keywords provided"),!1):(o.keywords=n,!0)}setCategory(e,t){const o=this.kaomojis.find(t=>t.kaomoji===e);return o?(o.category=t||"",!0):(console.warn(`Kaomoji "${e}" not found`),!1)}setWeight(e,t){const o=this.kaomojis.find(t=>t.kaomoji===e);return o?"number"==typeof t&&t>0?(o.weight=t,!0):(console.warn("Weight must be a positive number"),!1):(console.warn(`Kaomoji "${e}" not found`),!1)}addKaomoji(e){return!!this._validateItem(e,"new")&&(this.kaomojis.find(t=>t.kaomoji===e.kaomoji)?(console.warn(`Kaomoji "${e.kaomoji}" already exists`),!1):(this.kaomojis.push(this._normalizeItem(e)),!0))}removeKaomoji(e){const t=this.kaomojis.findIndex(t=>t.kaomoji===e);return-1===t?(console.warn(`Kaomoji "${e}" not found`),!1):(this.kaomojis.splice(t,1),!0)}updateKaomoji(e,t){const o=this.kaomojis.findIndex(t=>t.kaomoji===e);return-1===o?(console.warn(`Kaomoji "${e}" not found`),!1):!!this._validateItem(t,"update")&&(t.kaomoji!==e&&this.kaomojis.find(e=>e.kaomoji===t.kaomoji)?(console.warn(`Kaomoji "${t.kaomoji}" already exists`),!1):(this.kaomojis[o]=this._normalizeItem(t),!0))}exportToJSON(e=!0){return JSON.stringify(this.kaomojis,null,e?2:0)}exportToArray(){return this.kaomojis.map(e=>({...e,keywords:[...e.keywords]}))}batchSetCategory(e,t){let o=0;return e.forEach(e=>{this.setCategory(e,t)&&o++}),o}batchRemove(e){let t=0;return e.forEach(e=>{this.removeKaomoji(e)&&t++}),t}clear(){this.kaomojis=[]}}const r="kaomojis",i="kaomoji_data";let s=!1;function c(e,...t){s&&console.log("[KaomojiReplacer] "+e,...t)}function a(e,...t){s&&console.warn("[KaomojiReplacer] "+e,...t)}function l(e,...t){s?console.error("[KaomojiReplacer] "+e,...t):console.error("[KaomojiReplacer] "+e)}function d(){return new Promise((e,t)=>{if("undefined"==typeof indexedDB)return void t(Error("IndexedDB is not supported in this environment"));const o=indexedDB.open("KaomojiReplacerDB",1);o.onerror=()=>{t(Error("Failed to open IndexedDB"))},o.onsuccess=()=>{e(o.result)},o.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(r)||t.createObjectStore(r)}})}async function m(){try{const e=await d();return new Promise((t,o)=>{const n=e.transaction([r],"readonly"),s=n.objectStore(r).get(i);n.oncomplete=()=>{e.close()},n.onerror=()=>{e.close(),o(Error("Transaction failed"))},s.onsuccess=()=>{t(s.result||null)},s.onerror=()=>{o(Error("Failed to read from IndexedDB"))}})}catch(e){return l("Error reading from IndexedDB:",e),null}}async function h(e){if(!Array.isArray(e))return l("Data must be an array"),!1;try{const t=await d();return new Promise((o,n)=>{const s=t.transaction([r],"readwrite"),a=s.objectStore(r).put(e,i);s.oncomplete=()=>{t.close(),c(`Saved ${e.length} kaomojis to IndexedDB`),o(!0)},s.onerror=()=>{t.close(),n(Error("Transaction failed"))},a.onerror=()=>{n(Error("Failed to save to IndexedDB"))}})}catch(e){return l("Error saving to IndexedDB:",e),!1}}var u=Object.freeze({__proto__:null,clearKaomojis:async function(){try{const e=await d();return new Promise((t,o)=>{const n=e.transaction([r],"readwrite"),s=n.objectStore(r).delete(i);n.oncomplete=()=>{e.close(),c("Cleared kaomojis from IndexedDB"),t(!0)},n.onerror=()=>{e.close(),o(Error("Transaction failed"))},s.onerror=()=>{o(Error("Failed to clear IndexedDB"))}})}catch(e){return l("Error clearing IndexedDB:",e),!1}},getKaomojis:m,getStorageStats:async function(){try{const e=await m();return{hasData:null!==e,count:e?e.length:0,sizeKB:e?(JSON.stringify(e).length/1024).toFixed(2):"0.00"}}catch(e){return{hasData:!1,count:0,sizeKB:0,error:e.message}}},initKaomojiStorage:async function(e={}){const{defaultURL:t=null,forceReload:o=!1}=e;try{if(!o){const e=await m();if(e&&e.length>0)return c(`Loaded ${e.length} kaomojis from IndexedDB cache`),e}if(t){c(`Loading default kaomojis from ${t}...`);const e=await async function(e){try{const t=await fetch(e);if(!t.ok)return a(`Failed to fetch from ${e}: ${t.status}`),null;const o=await t.json();return Array.isArray(o)?o:(a("Remote data is not an array"),null)}catch(e){return a("Failed to load from remote:",e),null}}(t);if(e&&e.length>0)return await h(e),c(`Initialized with ${e.length} kaomojis from remote`),e;a("Failed to load from remote, returning empty array")}return[]}catch(e){return l("Error initializing kaomoji storage:",e),[]}},saveKaomojis:h,setDebugMode:function(e){s=e}});function g(e={}){const{kaomojis:r=[],jsonData:i=null,searchConfig:s={},replaceConfig:c={}}=e,a=new o(s),l=new t(a);if(c&&l.setConfig(c),i){const e=new n;e.loadFromJSON(i),l.loadKaomojis(e.getAllKaomojis())}else r.length>0&&l.loadKaomojis(r);return l}const{initKaomojiStorage:f,getKaomojis:y,saveKaomojis:w,clearKaomojis:p,getStorageStats:E,setDebugMode:k}=u;e.DEFAULT_CONFIG={search:{k1:1.5,b:.75},replace:{markerPattern:/\[kaomoji:([^\]]+)\]/gi,keywordSeparator:",",replaceStrategy:"best"}},e.KaomojiDataManager=n,e.KaomojiReplacer=t,e.IndexedDBStorage=u,e.REPLACE_STRATEGIES={FIRST:"first",BEST:"best",ALL:"all"},e.SearchEngine=o,e.VERSION="1.0.4",e.batchReplace=function(e,t,o={}){return g({kaomojis:Array.isArray(t)?t:[],jsonData:"string"==typeof t?t:null,searchConfig:o.searchConfig,replaceConfig:o.replaceConfig}).replaceMultiple(e,o)},e.clearKaomojis=p,e.createManager=function(e=null){const t=new n;return e&&("string"==typeof e?t.loadFromJSON(e):Array.isArray(e)&&t.loadFromArray(e)),t},e.createReplacer=g,e.createSearchEngine=function(e={}){return new o(e)},e.getKaomojis=y,e.getStorageStats=E,e.initKaomojiStorage=f,e.loadFromFile=async function(e){if("undefined"==typeof process)throw Error("loadFromFile is only available in Node.js environment");const{promises:t}=await import("fs"),o=await t.readFile(e,"utf8"),r=new n;return r.loadFromJSON(o),r.getAllKaomojis()},e.loadFromURL=async function(e){const t=await fetch(e);if(!t.ok)throw Error(`Failed to load from URL: ${t.status} ${t.statusText}`);const o=await t.text(),r=new n;return r.loadFromJSON(o),r.getAllKaomojis()},e.quickQuery=function(e,t,o=5){return g({kaomojis:Array.isArray(t)?t:[],jsonData:"string"==typeof t?t:null}).query(e,o)},e.quickReplace=function(e,t,o={}){return g({kaomojis:Array.isArray(t)?t:[],jsonData:"string"==typeof t?t:null,searchConfig:o.searchConfig,replaceConfig:o.replaceConfig}).replaceText(e,o)},e.saveKaomojis=w,e.setDebugMode=k,e.validateData=function(e){const t=[];return Array.isArray(e)?(e.forEach((e,o)=>{"object"==typeof e&&null!==e?(e.kaomoji&&"string"==typeof e.kaomoji||t.push(`Item ${o}: Missing or invalid 'kaomoji' field`),e.keywords&&Array.isArray(e.keywords)&&0!==e.keywords.length||t.push(`Item ${o}: Missing or invalid 'keywords' field`),void 0===e.weight||"number"==typeof e.weight&&e.weight>0||t.push(`Item ${o}: Invalid 'weight' field (must be positive number)`)):t.push(`Item ${o}: Must be an object.`)}),{valid:0===t.length,errors:t}):{valid:!1,errors:["Data must be an array"]}}});
//# sourceMappingURL=kaomoji-replacer.umd.min.js.map
