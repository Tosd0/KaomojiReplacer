<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB å­˜å‚¨æ¼”ç¤º - Kaomoji Replacer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
            margin-right: 10px;
        }

        button:hover {
            background: #5568d3;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .output {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border: 2px solid #e0e0e0;
            min-height: 60px;
        }

        .output.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .output.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .log {
            background: #f1f3f5;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .badge.success {
            background: #d4edda;
            color: #155724;
        }

        .badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ IndexedDB å­˜å‚¨æ¼”ç¤º</h1>
        <p class="subtitle">å‰ç«¯é¡¹ç›®çš„é¢œæ–‡å­—æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆ</p>

        <!-- åˆå§‹åŒ–å­˜å‚¨ -->
        <div class="section">
            <h2>1ï¸âƒ£ åˆå§‹åŒ–å­˜å‚¨</h2>
            <div class="input-group">
                <label for="defaultURL">é»˜è®¤æ•°æ® URLï¼ˆå¯é€‰ï¼‰:</label>
                <input type="text" id="defaultURL"
                       placeholder="https://cdn.example.com/kaomojis.json"
                       value="../data/kaomojis.template.json">
            </div>
            <button onclick="initStorage()">åˆå§‹åŒ–å­˜å‚¨</button>
            <button onclick="initStorage(true)" class="secondary">å¼ºåˆ¶é‡æ–°åŠ è½½</button>
            <div id="initOutput" class="output"></div>

            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="statCount">0</div>
                    <div class="stat-label">é¢œæ–‡å­—æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statSize">0 KB</div>
                    <div class="stat-label">æ•°æ®å¤§å°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statStatus">â“</div>
                    <div class="stat-label">ç¼“å­˜çŠ¶æ€</div>
                </div>
            </div>
        </div>

        <!-- æ–‡æœ¬æ›¿æ¢ -->
        <div class="section">
            <h2>2ï¸âƒ£ æ–‡æœ¬æ›¿æ¢æµ‹è¯•</h2>
            <div class="input-group">
                <label for="inputText">è¾“å…¥æ–‡æœ¬:</label>
                <textarea id="inputText" placeholder="ä»Šå¤©[kaomoji:å¼€å¿ƒ,é«˜å…´]åˆå­¦ä¼šäº†æ–°æŠ€èƒ½ï¼">ä»Šå¤©çœŸæ˜¯[kaomoji:æ— è¯­,é»‘è„¸]ï¼Œé‡åˆ°äº†å¥½å¤šbugï¼Œæƒ³è¦[kaomoji:æ€æ¡Œ,æ„¤æ€’]ï¼</textarea>
            </div>
            <button onclick="replaceText()">æ›¿æ¢æ–‡æœ¬</button>
            <div id="replaceOutput" class="output"></div>
        </div>

        <!-- æ‰‹åŠ¨ç®¡ç† -->
        <div class="section">
            <h2>3ï¸âƒ£ æ‰‹åŠ¨ç®¡ç†å­˜å‚¨</h2>
            <button onclick="readStorage()">è¯»å–æ•°æ®</button>
            <button onclick="refreshStats()" class="secondary">åˆ·æ–°ç»Ÿè®¡</button>
            <button onclick="clearStorage()" class="danger">æ¸…ç©ºç¼“å­˜</button>
            <div id="manageOutput" class="output"></div>
        </div>

        <!-- æ“ä½œæ—¥å¿— -->
        <div class="section">
            <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
            <button onclick="clearLog()" class="secondary">æ¸…ç©ºæ—¥å¿—</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- åŠ è½½åº“ -->
    <script type="module">
        // å¯¼å…¥æ ¸å¿ƒæ¨¡å—
        import SearchEngine from '../src/core/SearchEngine.js';
        import KaomojiReplacer from '../src/core/KaomojiReplacer.js';
        import KaomojiDataManager from '../src/core/KaomojiDataManager.js';
        import * as IndexedDBStorage from '../src/storage/IndexedDBStorage.js';

        let currentKaomojis = [];

        // æ—¥å¿—è®°å½•
        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.insertBefore(entry, log.firstChild);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…ç©º');
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        async function refreshStats() {
            try {
                const stats = await IndexedDBStorage.getStorageStats();

                document.getElementById('statCount').textContent = stats.count;
                document.getElementById('statSize').textContent = stats.sizeKB + ' KB';
                document.getElementById('statStatus').textContent = stats.hasData ? 'âœ…' : 'âŒ';
                document.getElementById('stats').style.display = 'grid';

                addLog(`ç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–°: ${stats.count} ä¸ªé¢œæ–‡å­—, ${stats.sizeKB} KB`);
            } catch (error) {
                addLog(`è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 1. åˆå§‹åŒ–å­˜å‚¨
        async function initStorage(forceReload = false) {
            const output = document.getElementById('initOutput');
            const url = document.getElementById('defaultURL').value.trim();

            try {
                output.textContent = 'æ­£åœ¨åˆå§‹åŒ–...';
                output.className = 'output';

                const kaomojis = await IndexedDBStorage.initKaomojiStorage({
                    defaultURL: url || null,
                    forceReload: forceReload
                });

                currentKaomojis = kaomojis;
                output.textContent = `âœ… åˆå§‹åŒ–æˆåŠŸï¼åŠ è½½äº† ${kaomojis.length} ä¸ªé¢œæ–‡å­—`;
                output.className = 'output success';

                addLog(`åˆå§‹åŒ–æˆåŠŸ: ${kaomojis.length} ä¸ªé¢œæ–‡å­— ${forceReload ? '(å¼ºåˆ¶é‡è½½)' : ''}`);
                await refreshStats();
            } catch (error) {
                output.textContent = `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`;
                output.className = 'output error';
                addLog(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 2. æ›¿æ¢æ–‡æœ¬
        async function replaceText() {
            const output = document.getElementById('replaceOutput');
            const input = document.getElementById('inputText').value;

            try {
                if (currentKaomojis.length === 0) {
                    output.textContent = 'âš ï¸ è¯·å…ˆåˆå§‹åŒ–å­˜å‚¨';
                    output.className = 'output error';
                    return;
                }

                // åˆ›å»ºæ›¿æ¢å™¨
                const engine = new SearchEngine();
                const replacer = new KaomojiReplacer(engine);
                replacer.loadKaomojis(currentKaomojis);

                // æ‰§è¡Œæ›¿æ¢
                const result = replacer.replaceText(input);

                output.innerHTML = `
                    <strong>è¾“å…¥:</strong> ${input}<br>
                    <strong>è¾“å‡º:</strong> ${result.text}<br>
                    <strong>ç»Ÿè®¡:</strong> æˆåŠŸ ${result.successCount} / å¤±è´¥ ${result.failureCount}
                `;
                output.className = 'output success';

                addLog(`æ›¿æ¢æ–‡æœ¬: ${result.successCount} æ¬¡æˆåŠŸ, ${result.failureCount} æ¬¡å¤±è´¥`);
            } catch (error) {
                output.textContent = `âŒ æ›¿æ¢å¤±è´¥: ${error.message}`;
                output.className = 'output error';
                addLog(`æ›¿æ¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 3. è¯»å–å­˜å‚¨
        async function readStorage() {
            const output = document.getElementById('manageOutput');

            try {
                const data = await IndexedDBStorage.getKaomojis();

                if (data) {
                    currentKaomojis = data;
                    output.textContent = `âœ… è¯»å–æˆåŠŸï¼æ‰¾åˆ° ${data.length} ä¸ªé¢œæ–‡å­—`;
                    output.className = 'output success';
                    addLog(`ä» IndexedDB è¯»å–: ${data.length} ä¸ªé¢œæ–‡å­—`);
                } else {
                    output.textContent = 'âš ï¸ IndexedDB ä¸­æ²¡æœ‰æ•°æ®';
                    output.className = 'output';
                    addLog('IndexedDB ä¸­æ²¡æœ‰æ•°æ®');
                }

                await refreshStats();
            } catch (error) {
                output.textContent = `âŒ è¯»å–å¤±è´¥: ${error.message}`;
                output.className = 'output error';
                addLog(`è¯»å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 4. æ¸…ç©ºå­˜å‚¨
        async function clearStorage() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©º IndexedDB ç¼“å­˜å—ï¼Ÿ')) {
                return;
            }

            const output = document.getElementById('manageOutput');

            try {
                await IndexedDBStorage.clearKaomojis();
                currentKaomojis = [];

                output.textContent = 'âœ… ç¼“å­˜å·²æ¸…ç©º';
                output.className = 'output success';
                addLog('IndexedDB ç¼“å­˜å·²æ¸…ç©º');

                await refreshStats();
            } catch (error) {
                output.textContent = `âŒ æ¸…ç©ºå¤±è´¥: ${error.message}`;
                output.className = 'output error';
                addLog(`æ¸…ç©ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ—¥å¿—
        window.addEventListener('DOMContentLoaded', () => {
            addLog('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å°±ç»ªï¼');
            refreshStats();
        });

        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿ HTML onclick å¯ä»¥è°ƒç”¨
        window.initStorage = initStorage;
        window.replaceText = replaceText;
        window.readStorage = readStorage;
        window.refreshStats = refreshStats;
        window.clearStorage = clearStorage;
        window.clearLog = clearLog;
    </script>
</body>
</html>
